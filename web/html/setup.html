<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>wichess setup</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville">
    <link rel="stylesheet" href="/css/body.css">
    <style>
        div {
            text-align: center;
            margin: auto;
            width: 100%;
        }
        .spacer {
            height: 50px;
        }
        table {
            border-collapse: collapse;
            table-layout: fixed;
            margin: auto;
            font-size: 12px;
        }
        #slots tr {
            height: 64px;
        }
        #slots td {
            width: 64px;
        }
        #pieces {
            font-size: 16px;
        }
        #pieces td {
            width: 64px;
            padding: 0.5em;
        }
        .point {
            border: solid black 0.5px;
            width: 64px;
            background-color: white;
        }
        .selected {
            border: solid black 2px;
        }
        .noselect {
            border: none;
            background-color: #cc785c;
        }
    </style>
    <script type="text/javascript" src="/js/jquery-2.2.0.min.js"></script>
    <script type="text/javascript">
        var pieceType = {
            ROOK: 1,
            KNIGHT: 2,
            BISHOP: 3,
        };
        var k = {
            SWAP: 7,
            LOCK: 8,
            RECON: 9,
            DETONATE: 10,
            GHOST: 11,
            STEAL: 12,
            GUARD: 13,
            RALLY: 14,
            FORTIFY: 15,
        };
        function stringForKind(kind) {
            switch(kind) {
                case k.SWAP:
                    return 'Swap';
                case k.LOCK:
                    return 'Lock';
                case k.RECON:
                    return 'Recon';
                case k.DETONATE:
                    return 'Detonate';
                case k.GHOST:
                    return 'Ghost';
                case k.STEAL:
                    return 'Steal';
                case k.GUARD:
                    return 'Guard';
                case k.RALLY:
                    return 'Rally';
                case k.FORTIFY:
                    return 'Fortify';
            }
        }
        var pieceCount = 0;
        var pieces = null;
        var pointselected = null;

        $(document).ready(function() {
            $.get("pieces").done(function(data) {
                pieces = data;
                pieceCount = data.length;
                for (var i = 0; i < pieceCount; i++) {
                    pieces[i].Used = false;
                    switch (pieces[i].Kind) {
                        case k.SWAP:
                        case k.LOCK:
                        case k.RECON:
                            pieces[i].PieceType = pieceType.KNIGHT;
                            break;
                        case k.DETONATE:
                        case k.GHOST:
                        case k.STEAL:
                            pieces[i].PieceType = pieceType.BISHOP;
                            break;
                        case k.GUARD:
                        case k.RALLY:
                        case k.FORTIFY:
                            pieces[i].PieceType = pieceType.ROOK;
                            break;
                    }
                }
                $('.point').click(function() {
                    var newpointselected = $(this);
                    if (newpointselected.hasClass('noselect')) {
                        return;
                    }
                    if (newpointselected.is(pointselected)) {
                        pointselected.toggleClass('selected');
                        pointselected = null;
                        $('#pieces').html('');
                        return;
                    }
                    if (pointselected != null) {
                        pointselected.toggleClass('selected');
                    }
                    pointselected = newpointselected;
                    pointselected.toggleClass('selected');
                    generatePiecesTable();
                });
            });
        });
        function generatePiecesTable() {
            var kind;
            switch (pointselected.attr('id')) {
                case 'leftrook':
                case 'rightrook':
                    kind = pieceType.ROOK;
                    break;
                case 'leftknight':
                case 'rightknight':
                    kind = pieceType.KNIGHT;
                    break;
                case 'leftbishop':
                case 'rightbishop':
                    kind = pieceType.BISHOP;
                    break;
            }
            $('#pieces').html('');
            var table = '<tr><td></td><td>Kind</td><td>Takes</td></tr>';
            var has = false;
            for (var i = 0; i < pieceCount; i++) {
                if (pieces[i].PieceType != kind) {
                    continue;
                }
                if (pieces[i].Used) {
                    continue;
                }
                has = true;
                table += '<tr><td><input id="'+pieces[i].Identifier+'" type="button" value="Assign" onclick="assignPiece(pieceWithID(parseInt($(this).attr(&quot;id&quot;))));"/></td><td>'+stringForKind(pieces[i].Kind)+'</td><td>'+pieces[i].Takes+'</td></tr>';
            }
            if (has) $('#pieces').html(table);
        }
        var leftrook = null, leftknight = null, leftbishop = null, rightbishop = null, rightknight = null, rightrook = null;
        function assignPiece(piece) {
            piece.Used = true;
            $('#'+pointselected.attr('id')+'deselect').html('<input id="'+piece.Identifier+'" type="button" value="Unassign" onclick="deassignPiece(pieceWithID(parseInt($(this).attr(&quot;id&quot;))));"/>');
            switch (pointselected.attr('id')) {
                case 'leftrook':
                    if (leftrook != null) {
                        leftrook.Used = false;
                    }
                    leftrook = piece;
                    break;
                case 'leftknight':
                    if (leftknight != null) {
                        leftknight.Used = false;
                    }
                    leftknight = piece;
                    break;
                case 'leftbishop':
                    if (leftbishop != null) {
                        leftbishop.Used = false;
                    }
                    leftbishop = piece;
                    break;
                case 'rightbishop':
                    if (rightbishop != null) {
                        rightbishop.Used = false;
                    }
                    rightbishop = piece;
                    break;
                case 'rightknight':
                    if (rightknight != null) {
                        rightbishop.Used = false;
                    }
                    rightknight = piece;
                    break;
                case 'rightrook':
                    if (rightrook != null) {
                        rightrook.Used = false;
                    }
                    rightrook = piece;
                    break;
            }
            pointselected.html(stringForKind(piece.Kind));
            generatePiecesTable();
        }
        function deassignPiece(piece) {
            piece.Used = false;
            if (leftrook != null) {
                if (leftrook.Identifier == piece.Identifier) {
                    leftrook = null;
                    $('#leftrook').html('');
                    $('#leftrookdeselect').html('');
                }
            } else if (leftknight != null) {
                if (leftknight.Identifier == piece.Identifier) {
                    leftknight = null;
                    $('#leftknight').html('');
                    $('#leftknightdeselect').html('');
                }
            } else if (leftbishop != null) {
                if (leftbishop.Identifier == piece.Identifier) {
                    leftbishop = null;
                    $('#leftbishop').html('');
                    $('#leftbishopdeselect').html('');
                }
            } else if (rightbishop != null) {
                if (rightbishop.Identifier == piece.Identifier) {
                    rightbishop = null;
                    $('#rightbishop').html('');
                    $('#rightbishopdeselect').html('');
                }
            } else if (rightknight != null) {
                if (rightknight.Identifier == piece.Identifier) {
                    rightknight = null;
                    $('#rightknight').html('');
                    $('#rightknightdeselect').html('');
                }
            } else if (rightrook != null) {
                if (rightrook.Identifier == piece.Identifier) {
                    rightrook = null;
                    $('#rightrook').html('');
                    $('#rightrookdeselect').html('');
                }
            }
            if (pointselected != null) generatePiecesTable();
        }
        function pieceWithID(id) {
            for (var i = 0; i < pieceCount; i++) {
                if (pieces[i].Identifier == id) {
                    return pieces[i];
                }
            }
            return null;
        }
        function requestGame(computer) {
            var lr = 0, lk = 0, lb = 0, rr = 0, rk = 0, rb = 0;
            if (leftrook != null) {
                lr = leftrook.Identifier;
            }
            if (leftknight != null) {
                lk = leftknight.Identifier;
            }
            if (leftbishop != null) {
                lb = leftbishop.Identifier;
            }
            if (rightbishop != null) {
                rb = rightbishop.Identifier;
            }
            if (rightknight != null) {
                rk = rightknight.Identifier;
            }
            if (rightrook != null) {
                rr = rightrook.Identifier;
            }
            jQuery.post('request', {
                point: window.location.pathname.substring(1, window.location.pathname.length),
                lrook: lr,
                lknight: lk,
                lbishop: lb,
                rbishop: rb,
                rknight: rk,
                rrook: rr,
                computer: computer
            }).done(function() {
                window.location.pathname = '/';
            });
        }
    </script>
</head>

<body>
<div class="spacer"></div>
<div>
    <table>
        <tr>
            <td><input type="button" value="Match Human" onclick="requestGame(false);"/></td>
        </tr>
        <tr>
            <td><input type="button" value="Play Computer" onclick="requestGame(true);"/></td>
        </tr>
    </table>
</div>
<div>
    <table id="slots">
        <tr>
            <td id="leftrook" class="point"></td>
            <td id="leftknight" class="point"></td>
            <td id="leftbishop" class="point"></td>
            <td class="point noselect"></td>
            <td class="point noselect"></td>
            <td id="rightbishop" class="point"></td>
            <td id="rightknight" class="point"></td>
            <td id="rightrook" class="point"></td>
        </tr>
        <tr>
            <td id="leftrookdeselect"></td>
            <td id="leftknightdeselect"></td>
            <td id="leftbishopdeselect"></td>
            <td></td><td></td>
            <td id="rightbishopdeselect"></td>
            <td id="rightknightdeselect"></td>
            <td id="rightrookdeselect"></td>
        </tr>
    </table>
</div>
<div>
    <table id="pieces"></table>
</div>
</body>
</html>
