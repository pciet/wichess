<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>wichess index</title>
    <!-- Copyright 2017 Matthew Juran -->
    <!-- All Rights Reserved -->
    <meta name="apple-mobile-web-app-capable" content="yes">    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <style>
    body {
        background-color: #cc785c;
        margin: 0px;
        border: 0px;
        padding: 0px;
        font-family: 'Libre Baskerville', serif;
        color: #d4cca5;
    }
    input {
        -moz-appearance: none;
        -webkit-appearance: none;
        background-color: #fb835e;
        color: #d4cca5;
        box-shadow: 0px 1px 1px black;
        font-family: 'Libre Baskerville', serif;
    }
    .inline {
        display: inline-block;
        vertical-align: top;
    }
    #army, #mode, #games {
        vertical-align: top;
        padding: 5px;
    }
    #record {
        width: 100%;
        text-align: center;
        font-family: 'Inconsolata', monospace;
        color: #d4cca5;
    }
    .modebuttondiv, .gamebuttondiv {
        text-align: center;
    }
    .modebutton, .gamebutton {
        /* mode buttons are always within a container, the inline-block is a hack to shrink around the contained text */
        display: inline-block;
        border-radius: 10px;
        border: none;
        background-color: #fb835e;
        color: #d4cca5;
        box-shadow: 0px 1px 1px black;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
        cursor: default;
    }
    .disabled {
        color: #e1e1e1;
        background-color: #f3f3f3;
    }
    .modebuttonselected {
        border: 2px outset #d4cca5;
    }
    .armyrow {
        border: 7px outset #d4cca5;
        margin: 1px auto;
    }
    .armyselect {
        margin: 3px auto;
    }
    .armycell {
        float: left;
    }
    .selectcell {
        border-radius: 5px;
        border: 1px solid #d4cca5;
        overflow-y: scroll;
    }
    .even {
        background-color: #e1e1e1;
    }
    .odd {
        background-color: #f3f3f3;
    }
    .pieceimg {
        width: 100%;
        height: 100%;
    }
    table {
        margin: 0 auto;
        background-color: white;
        border-collapse: collapse;
    }
    table td {
        padding: 0px;
        vertical-align: top;
    }
    .frienddiv {
        text-align: center;
    }
    .friendmatching {
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
        cursor: default;
    }
    .friendmatched {
        display: inline-block;
        border-radius: 10px;
        background-color: #fb835e;
        color: #d4cca5;
        box-shadow: 0px 1px 1px black;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
        cursor: default;
    }
    .cancelbutton {
        display: inline-block;
        border-radius: 10px;
        border: none;
        background-color: #fb835e;
        color: #d4cca5;
        box-shadow: 0px 1px 1px black;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
        cursor: default;
    }
    .gameselectpoint {
        outline: 1px solid #d4cca5;
    }
    .selectpiece {
        height: 100%;
    }
    .selectpieceimg {
        height: 100%;
        width: 100%;
    }
    .noselect {
        background-color: #e1e1e1;
    }
    </style>
    <script type="text/javascript" src="/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="/js/jquery.fittext.js"></script>
    <script type="text/javascript" src="/js/js.cookie.js"></script>
    <script type="text/javascript" src="/js/pieces.js"></script>
    <script type="text/javascript">
    // https://stackoverflow.com/questions/8788802/prevent-safari-loading-from-cache-when-back-button-is-clicked/13123626#13123626
    // https://stackoverflow.com/questions/17432899/javascript-bfcache-pageshow-event-event-persisted-always-set-to-false
    $(window).bind("pageshow", function(event) {
        if (event.originalEvent.persisted || (window.performance && (window.performance.navigation.type == 2))) {
            window.location.reload();
        }
    });
    // match the css for #army, #mode, #games, assumes zero border and zero margin
    var BoxPadding = 5;
    // space around the army rows
    var ArmyPadding = 8;
    // space around a select cell
    var SelectCellPadding = 2;
    // space around a game cell
    var GameCellPadding = 1;

    var Modes = {
        COMPUTER: 0,
        FRIEND: 1,
        COMPETITIVE: 2,
        HOTSEAT: 3
    };
    var Clicked = null;

    var ModeCookie = 'mode';
    var StoredMode = Modes.COMPETITIVE;
    var c = Cookies.get(ModeCookie);
    if (c) {
        StoredMode = parseInt(c);
    }

    var Matching = false;
    var Matching5 = false;
    var Matching15 = false;

    // '' or name of opponent
    var FriendGames = [{{.F0}}, {{.F1}}, {{.F2}}, {{.F3}}, {{.F4}}, {{.F5}}];
    var FriendMatching = ['{{.F0Matching}}', '{{.F1Matching}}', '{{.F2Matching}}', '{{.F3Matching}}', '{{.F4Matching}}', '{{.F5Matching}}'];
    // true or false
    var FriendMoveable = [{{.F0Moveable}}, {{.F1Moveable}}, {{.F2Moveable}}, {{.F3Moveable}}, {{.F4Moveable}}, {{.F5Moveable}}];

    var Pieces = null;
    var Assignments = [];

    for (var i = 0; i < 16; i++) {
        Assignments[i] = 0;
    }

    var ws = new WebSocket('ws://'+window.location.host+'/friend');
    ws.onmessage = function(event) {
        var msg = JSON.parse(event.data);
        if (msg.moveable != -1) {
            FriendMoveable[msg.moveable] = true;
            var name = $('#fw'+msg.moveable).addClass('modebuttonselected');
        }
        if (msg.slot != -1) {
            FriendGames[msg.slot] = FriendMatching[msg.slot];
            FriendMatching[msg.slot] = '';
            setMatchedFriend(msg.slot);
        }
    }
    function layout(width, height) {
        var fitFactor = 1;
        var armyDim;
        if (width > height) { // horizontal
            var page = `
                <div class="inline" id="mode"><!--
                    --><div class="modebuttondiv"><!--
                        --><div class="modebutton" id="computermode">Computer</div><!--
                    --></div><!--
                    --><div class="modebuttondiv"><!--
                        --><div class="modebutton" id="friendmode">Friend</div><!--
                    --></div><!--
                    --><div class="modebuttondiv"><!--
                        --><div class="modebutton" id="competitivemode">Competitive</div><!--
                    --></div><!--
                    --><div class="modebuttondiv"><!--
                        --><div class="modebutton" id="hotseatmode">Hotseat</div><!--
                    --></div><!--
                --></div><!--
                --><div class="inline"><!--
                    --><div id="army"></div><!--
                    --><div id="games"></div><!--
                --></div>
            `;
            $(document.body).html(page);
            var onesWidth = (width / 6) - (BoxPadding * 2);
            var fivesWidth = ((width / 6) * 5) - (BoxPadding * 2);
            var twosHeight = ((height / 6) * 2) - (BoxPadding * 2);
            var foursHeight = ((height / 6) * 4) - (BoxPadding * 2);
            armyDim = (fivesWidth / 8) - ArmyPadding - SelectCellPadding;
            if ((((armyDim+(ArmyPadding*2))*2)+((armyDim+(SelectCellPadding*2))*2)) > foursHeight) {
                armyDim = (foursHeight / 4) - (ArmyPadding * 2);
            } 
            $('#army').width(fivesWidth).height(foursHeight);
            $('#games').width(fivesWidth).height(twosHeight);
            $('#mode').width(onesWidth).height(height - (BoxPadding * 2));
            $('.modebuttondiv').css('height', '25%').css('width', '100%');
            $('.modebutton').css('height', '94%').css('width', '100%');
            fitFactor = 0.7;
        } else if (height >= width) { // vertical
            var page = `
                <div id="games"></div><!--
                --><div id="army"></div><!--
                --><div id="mode"><!--
                    --><div style="height: 50%;"><!--
                        --><div class="modebuttondiv inline"><!--
                            --><div class="modebutton" id="computermode">Computer</div><!--
                        --></div><!--
                        --><div class="modebuttondiv inline"><!--
                            --><div class="modebutton" id="friendmode">Friend</div><!--
                        --></div><!--
                    --></div><!--
                    --><div style="height: 50%;"><!--
                        --><div class="modebuttondiv inline"><!--
                            --><div class="modebutton" id="competitivemode">Competitive</div><!--
                        --></div><!--
                        --><div class="modebuttondiv inline"><!--
                            --><div class="modebutton" id="hotseatmode">Hotseat</div><!--
                        --></div><!--
                    --></div><!--
                --></div>
            `;
            $(document.body).html(page);
            var onesHeight = (height / 6) - (BoxPadding * 2);
            var threesHeight = ((height / 6) * 3) - (BoxPadding * 2);
            var twosHeight = ((height / 6) * 2) - (BoxPadding * 2);
            armyDim = (threesHeight / 4) - ArmyPadding - SelectCellPadding;
            if ((width - (BoxPadding * 2)) < ((armyDim *8)+(2*ArmyPadding))) {
                armyDim = ((width - (BoxPadding * 2) - (SelectCellPadding * 2)) / 8) - (ArmyPadding/4);
            }
            $('#army').width(width - (BoxPadding * 2)).height(threesHeight);
            $('#games').width(width - (BoxPadding * 2)).height(twosHeight);
            $('#mode').width(width - (BoxPadding * 2)).height(onesHeight);
            $('.modebuttondiv').css('height', '100%').css('width', '50%');
            $('.modebutton').css('height', '86%').css('width', '98%');
            fitFactor = 1.2;
        }
        $('.modebutton').fitText(fitFactor);
        $('.modebutton').css('line-height', $('.modebutton').height() + 'px');
        if (Clicked != null) {
            var toClick = Clicked;
            Clicked = null;
            clickMode(toClick);
        }
        $('#computermode').click(function() {
            clickMode(Modes.COMPUTER);
        });
        $('#friendmode').click(function() {
            clickMode(Modes.FRIEND);
        });
        $('#competitivemode').click(function() {
            clickMode(Modes.COMPETITIVE);
        });
        $('#hotseatmode').click(function() {
            // TODO
            //clickMode(Modes.HOTSEAT);
        });
        // TODO
        $('#hotseatmode').addClass('disabled');
        var army = `
            <div class="armyrow" id="pawnrow"></div>
            <div class="armyselect" id="pawnselect"></div>
            <div class="armyrow" id="specialrow"></div>
            <div class="armyselect" id="specialselect"></div>
        `;
        $('#army').html(army);
        var pawnrow = '';
        var pawnselect = '';
        var specialrow = '';
        var specialselect = '';
        for (var i = 0; i < 8; i++) {
            pawnrow += '<div class="inline armycell" id="pawn'+(i+8)+'"><img class="pieceimg" src="/img/wpawn_64.png"></div>';
            pawnselect += '<div class="inline selectcell" id="pickpawn'+(i+8)+'"></div>';
            specialrow += '<div class="inline armycell" id="back'+i+'"></div>';
            specialselect += '<div class="inline selectcell" id="pickback'+i+'"></div>';
        }
        $('#pawnrow').html(pawnrow);
        $('#pawnselect').html(pawnselect);
        $('#specialrow').html(specialrow);
        $('#specialselect').html(specialselect);
        for (var i = 0; i < 2; i++) {
            for (var j = 0; j < 8; j++) {
                if (i == 0) {
                    if (j % 2) {
                        $('#back'+j).addClass('odd');
                    } else {
                        $('#back'+j).addClass('even');
                    }
                } else {
                    if (j % 2) {
                        $('#pawn'+(j+8)).addClass('even');
                    } else {
                        $('#pawn'+(j+8)).addClass('odd');
                    }
                }
            }
        }
        $('#back0').html('<img class="pieceimg" src="/img/wrook_64.png">');
        $('#back1').html('<img class="pieceimg" src="/img/wknight_64.png">');
        $('#back2').html('<img class="pieceimg" src="/img/wbishop_64.png">');
        $('#back3').html('<img class="pieceimg" src="/img/wqueen_64.png">');
        $('#back4').html('<img class="pieceimg" src="/img/wking_64.png">');
        $('#back5').html('<img class="pieceimg" src="/img/wbishop_64.png">');
        $('#back6').html('<img class="pieceimg" src="/img/wknight_64.png">');
        $('#back7').html('<img class="pieceimg" src="/img/wrook_64.png">');
        $('.armycell').css('width', armyDim+'px').css('height', armyDim+'px');
        $('.armyrow').css('height', armyDim+'px').css('width', (armyDim*8)+'px');
        $('.selectcell').css('width', (armyDim-SelectCellPadding)+'px').css('height', (armyDim-SelectCellPadding)+'px');
        $('.armyselect').css('height', (armyDim+(2*SelectCellPadding))+'px').css('width', (((armyDim-(2*SelectCellPadding))*8)+(16*SelectCellPadding))+'px');
        $('#pawnrow').css('margin-top', (($('#army').height() - ($('.armyrow').height() * 2) - ($('.armyselect').height() * 2)) / 4) + 'px');
    }
    var setMatchedFriend = function(index) {
        $('#f'+index).html('<div id="fw'+index+'">'+FriendGames[index]+'</div>');
        $('#fw'+index).css('width', '80%').css('height', '80%')
            .fitText(1.4)
            .css('line-height', $('#fw'+index).height() + 'px')
            .addClass('friendmatched')
            .click({Index: index}, function(event) {
            window.location.href = '/friend/'+event.data.Index;
        });
        if (FriendMoveable[index] != false) {
            $('#fw'+index).addClass('modebuttonselected');
        }
    };
    function clickMode(mode) {
        if (Clicked != null) {
            switch (Clicked) {
                case Modes.COMPUTER:
                    $('#computermode').removeClass('modebuttonselected');
                    break;
                case Modes.FRIEND:
                    $('#friendmode').removeClass('modebuttonselected');
                    break;
                case Modes.COMPETITIVE:
                    $('#competitivemode').removeClass('modebuttonselected');
                    break;
                case Modes.HOTSEAT:
                    $('#hotseatmode').removeClass('modebuttonselected');
                    break;
            }
        }
        if (Clicked == mode) {
            Clicked = null;
            $('#games').html('');
            return;
        }
        Cookies.set(ModeCookie, mode.toString(), {expires: 30});
        switch (mode) {
            case Modes.COMPUTER:
                $('#computermode').addClass('modebuttonselected');
                var layout = `
                    <div class="inline gamebuttondiv">
                        <div class="gamebutton" id="easycomputer">Easy</div>
                    </div>
                    <div class="inline gamebuttondiv">
                        <div class="gamebutton" id="hardcomputer">Hard</div>
                    </div>
                `;
                $('#games').html(layout);
                $('.gamebuttondiv').css('width', (($('#games').width() / 2) - BoxPadding) + 'px').css('height', '100%');
                $('.gamebutton').css('width', '90%').css('height', '60%');
                $('.gamebutton').fitText(0.9);
                $('.gamebutton').css('margin-top', (($('.gamebuttondiv').height() - $('.gamebutton').height()) / 2) + 'px');
                $('#easycomputer').click(function() {
                    jQuery.post('easycomputerrequest', JSON.stringify({assignments: Assignments})).done(function() {
                        window.location.pathname = '/easycomputer';
                    });
                });
                $('#hardcomputer').click(function() {
                    // TODO
                    //jQuery.post('hardcomputerrequest', JSON.stringify({assignments: Assignments})).done(function() {
                    //    window.location.pathname = '/hardcomputer';
                    //});
                });
                $('#hardcomputer').addClass('disabled');
                break;
            case Modes.FRIEND:
                $('#friendmode').addClass('modebuttonselected');
                var layout = `
                    <div class="inline"><!--
                        --><div id="f0" class="frienddiv"></div><!--
                        --><div id="f1" class="frienddiv"></div><!--
                        --><div id="f2" class="frienddiv"></div><!--
                    --></div><!--
                    --><div class="inline"><!--
                        --><div id="f3" class="frienddiv"></div><!--
                        --><div id="f4" class="frienddiv"></div><!--
                        --><div id="f5" class="frienddiv"></div><!--
                    --></div>
                `;
                $('#games').html(layout);
                var h = $('#games').height() / 3;
                var w = $('#games').width() / 2;
                var setNoFriend = function(index) {
                    var e = $('#f'+index);
                    e.html('<input id="friendinput'+index+'" type="text" placeholder="Open"><div class="fispacer inline"></div><input id="friendsubmit'+index+'" type="submit" value=">">');
                    $('#friendinput'+index).css('box-sizing', 'border-box').css('height', '80%').css('width', '60%').fitText(1.2);
                    $('#friendsubmit'+index).css('box-sizing', 'border-box').css('height', '80%').css('width', '20%').fitText(0.3);
                    $('.fispacer').css('width', '5%');
                    $('#friendsubmit'+index).click({Index: index}, function(event) {
                        if ($('#friendinput'+event.data.Index).val() == '') {
                            return;
                        }
                        FriendMatching[event.data.Index] = $('#friendinput'+event.data.Index).val();
                        setMatchingFriend(event.data.Index);
                        jQuery.post('friend/'+event.data.Index, 
                            JSON.stringify({friend: FriendMatching[event.data.Index], assignments: Assignments}))
                        .done(function(data) {
                            if (data == true) {
                                FriendGames[event.data.Index] = FriendMatching[event.data.Index];
                                FriendMatching[event.data.Index] = '';
                                // the player that gets a true response from this post is the first active player
                                FriendMoveable[event.data.Index] = true;
                                setMatchedFriend(event.data.Index);
                            }
                        });
                    });
                };
                var setMatchingFriend = function(index) {
                    var e = $('#f'+index);
                    e.html('<div class="inline" id="friendname'+index+'">Matching '+FriendMatching[index]+'</div><div class="matchingspacer inline"></div><div class="inline cancelbutton" id="cancelfriend'+index+'">Cancel</div>');
                    $('#friendname'+index).css('width', '60%').css('height', '100%').css('box-model', 'border-box').fitText(1.2).css('line-height', $('#friendname'+index).height() + 'px').addClass('friendmatching');
                    $('.matchingspacer').css('box-model', 'border-box').css('width', '5%');
                    $('#cancelfriend'+index).css('width', '20%').css('height', '80%').css('box-model', 'border-box').fitText(0.6).css('line-height', $('#cancelfriend'+index).height() + 'px');
                    $('#cancelfriend'+index).click({Index: index}, function(event) {
                        var ci = event.data.Index;
                        jQuery.post('friendcancel/'+event.data.Index).done(function() {
                            FriendMatching[ci] = '';
                            setNoFriend(ci);
                        });
                    });
                };

                $('.frienddiv').each(function(index, element) {
                    var e = $(element);
                    e.css('box-sizing', 'border-box');
                    e.css('height', h + 'px');
                    e.css('width', w + 'px');
                    if (FriendGames[index] != '') {
                        setMatchedFriend(index);
                    } else if (FriendMatching[index] != '') {
                        setMatchingFriend(index);
                    } else {
                        setNoFriend(index);
                    }
                });
                break;
            case Modes.COMPETITIVE:
                $('#competitivemode').addClass('modebuttonselected');
                var layout = `
                    <div id="record" style="height: 25%;">+{{.Wins}} / -{{.Losses}} / ={{.Draws}}</div>
                    <div style="height: 5%;"></div>
                    <div id="competitivebuttons" style="height: 72%;">
                        <div class="inline competitivebuttondiv">
                            <div class="gamebuttondiv">
                                <div class="gamebutton" id="matched15">15 Minute</div>
                            </div>
                        </div>
                        <div class="inline competitivebuttondiv">
                            <div class="gamebuttondiv">
                                <div class="gamebutton" id="matched5">5 Minute</div>
                            </div>
                        </div>
                    </div>
                `;
                $('#games').html(layout);
                $('.competitivebuttondiv').css('width', (($('#games').width() / 2) - BoxPadding) + 'px').css('height', '100%');
                $('#record').fitText(2.1);
                $('.gamebuttondiv').css('width', '100%').css('height', '90%');
                $('.gamebutton').css('width', '90%').css('height', '90%');
                if ($(window).height() > $(window).width()) {
                    $('.gamebutton').fitText();
                } else { 
                    $('.gamebutton').fitText(1.4);
                }
               $('#matched15').click(function() {
                    Clicked = null;
                    jQuery.post('competitive15', JSON.stringify({assignments: Assignments})).done(function() {
                        window.location.pathname = '/competitive15';
                    }).fail(function() {}); // fails on cancel
                    Matching15 = true;
                    match15Competitive();

                });
                $('#matched5').click(function() {
                    Clicked = null;
                    jQuery.post('competitive5', JSON.stringify({assignments: Assignments})).done(function() {
                        window.location.pathname = '/competitive5';
                    }).fail(function() {}); // fails on cancel
                    Matching5 = true;
                    match5Competitive();

                });
                break;
            case Modes.HOTSEAT:
                $('#hotseatmode').addClass('modebuttonselected');
                var layout = `
                    <div class="inline hotseatdiv">
                        <div class="gamebuttondiv">
                            <div class="gamebutton" id="hotwhite">White Army</div>
                        </div>
                        <div class="gamebuttondiv">
                            <div class="gamebutton" id="hotblack">Black Army</div>
                        </div>
                    </div>
                    <div class="inline hotseatdiv">
                        <div id="hotseatcenterer"></div>
                        <div class="gamebuttondiv">
                            <div class="gamebutton" id="playhot">Play</div>
                        </div>
                    </div>
                `;
                $('#games').html(layout);
                $('.hotseatdiv').css('width', (($('#games').width() - (BoxPadding * 2)) / 2) + 'px').css('height', '100%');
                $('.gamebuttondiv').css('width', '100%').css('height', '50%');
                $('.gamebutton').css('width', '90%').css('height', '90%');
                if ($(window).height() > $(window).width()) {
                    $('.gamebutton').fitText();
                } else { 
                    $('.gamebutton').fitText(1.4);
                }
                $('#hotseatcenterer').css('height', (($('#games').height() - (BoxPadding * 2)) / 4) + 'px');
                break;
        }
        $('.gamebutton').css('line-height', $('.gamebutton').height() + 'px');        
        Clicked = mode;
    }
    function match15Competitive() {
            var l = `
                <div id="spacer"></div>
                <div id="cmp">Matching 15 Minute Competitive</div>
                <div class="gamebuttondiv">
                    <div class="gamebutton" id="cancelmatched15" style="height: 100%; width: 100%;">Cancel</div>
                </div>
            `;
            $('body').html(l);
            $('#spacer').css('height', ($(window).height() / 6) + 'px');
            var margin = $(window).width() / 6;
            $('#cmp').css('height', ($(window).height() / 4) + 'px').css('width', ($(window).width() - (2 * margin)) + 'px').css('margin-left', margin + 'px').css('margin-right', margin + 'px').css('line-height', $('#cmp').height() + 'px').css('text-align', 'center').css('vertical-align', 'middle');
            if ($(window).height() > $(window).width()) {
                $('#cmp').fitText(2);
            } else {
                $('#cmp').fitText(3);
            }
            $('.gamebuttondiv').css('margin-left', margin + 'px').css('margin-right', margin + 'px').css('width', ($(window).width() - (2 * margin)) + 'px').css('height', ($(window).height() / 6) + 'px').css('line-height', $('.gamebuttondiv').height() + 'px').css('text-align', 'center').css('vertical-align', 'middle');
            $('.gamebutton').css('width', '100%').css('height', '100%').fitText(2);
            $('#cancelmatched15').click(function() {
                jQuery.post('cancelcompetitive15');
                Matching15 = false;
                layout($(window).width(), $(window).height());
                clickMode(Modes.COMPETITIVE);
                populateAvailablePieces();
            });
    }
    function match5Competitive() {
        var l = `
            <div id="spacer"></div>
            <div id="cmp">Matching 5 Minute Competitive</div>
            <div class="gamebuttondiv">
                <div class="gamebutton" id="cancelmatched5" style="height: 100%; width: 100%;">Cancel</div>
            </div>
        `;
        $('body').html(l);
        $('#spacer').css('height', ($(window).height() / 6) + 'px');
        var margin = $(window).width() / 6;
        $('#cmp').css('height', ($(window).height() / 4) + 'px').css('width', ($(window).width() - (2 * margin)) + 'px').css('margin-left', margin + 'px').css('margin-right', margin + 'px').css('line-height', $('#cmp').height() + 'px').css('text-align', 'center').css('vertical-align', 'middle');
        if ($(window).height() > $(window).width()) {
	     $('#cmp').fitText(2);
        } else {
	    $('#cmp').fitText(3);
        }
        $('.gamebuttondiv').css('margin-left', margin + 'px').css('margin-right', margin + 'px').css('width', ($(window).width() - (2 * margin)) + 'px').css('height', ($(window).height() / 6) + 'px').css('line-height', $('.gamebuttondiv').height() + 'px').css('text-align', 'center').css('vertical-align', 'middle');
        $('.gamebutton').css('width', '100%').css('height', '100%').fitText(2);
        $('#cancelmatched5').click(function() {
            jQuery.post('cancelcompetitive5');
            Matching5 = false;
            layout($(window).width(), $(window).height());
            clickMode(Modes.COMPETITIVE);
            populateAvailablePieces();
        });
    }
    $(window).resize(function() {
        if (Matching15) {
            match15Competitive();
        } else if (Matching5) {
            match5Competitive();
        } else {
            layout($(window).width(), $(window).height());
            populateAvailablePieces();
        }
    });
    function populateAvailablePieces() {
        for (var i = 0; i < Assignments.length; i++) {
            var piece = null;
            for (var j = 0; j < Pieces.length; j++) {
                if (Pieces[j].Identifier == Assignments[i]) {
                    piece = Pieces[j];
                    break;
                }
            }
            if (piece == null) {
                if (i < 8) {
                    $('#pawn'+(i+8)).html('<img class="pieceimg" src="/img/wpawn_64.png">');
                } else if ((i == 8) || (i == 15)) {
                    $('#back'+(i-8)).html('<img class="pieceimg" src="/img/wrook_64.png">');
                } else if ((i == 9) || (i == 14)) {
                    $('#back'+(i-8)).html('<img class="pieceimg" src="/img/wknight_64.png">');
                } else if ((i == 10) || (i == 13)) {
                    $('#back'+(i-8)).html('<img class="pieceimg" src="/img/wbishop_64.png">');
                } else if (i == 11) {
                    $('#back'+(i-8)).html('<img class="pieceimg" src="/img/wqueen_64.png">');
                } else if (i == 12) {
                    $('#back'+(i-8)).html('<img class="pieceimg" src="/img/wking_64.png">');
                }
                continue;
            }
            if (i < 8) {
                $('#pawn'+(i+8)).html('<img class="pieceimg" src="/img/'+imageNameForKind(piece.Kind, 64, o.WHITE)+'">');
            } else {
                $('#back'+(i-8)).html('<img class="pieceimg" src="/img/'+imageNameForKind(piece.Kind, 64, o.WHITE)+'">');
            }
        }
        var pawnList = [];
        var rookList = [];
        var knightList = [];
        var bishopList = [];
        for (var i = 0; i < Pieces.length; i++) {
            if (Pieces[i].assigned) {
                continue;
            }
            switch(Pieces[i].Base) {
                case k.PAWN:
                    pawnList.push(Pieces[i]);
                    break;
                case k.ROOK:
                    rookList.push(Pieces[i]);
                    break;
                case k.KNIGHT:
                    knightList.push(Pieces[i]);
                    break;
                case k.BISHOP:
                    bishopList.push(Pieces[i]);
                    break;
            }
        }
        for (var i = 0; i < 8; i++) {
            var layout = '';
            for (var j = 0; j < pawnList.length; j++) {
                layout += '<div class="selectpiece" id="sp'+i+'-'+j+'"><img class="selectpieceimg" src="/img/'+imageNameForKind(pawnList[j].Kind, 64, o.WHITE)+'"></div>';
            }
            if (pawnList.length == 0) {
                $('#pickpawn'+(8+i)).html('').addClass('noselect');
            } else {
                $('#pickpawn'+(8+i)).html(layout).removeClass('noselect');
            }
            for (var j = 0; j < pawnList.length; j++) {
                $('#sp'+i+'-'+j).click({Index: j, File: i}, function(event) {
                    for (var k = 0; k < Pieces.length; k++) {
                        if (Pieces[k].Identifier != pawnList[event.data.Index].Identifier) {
                            continue;
                        }
                        if (Assignments[event.data.File] != 0) {
                            for (var l = 0; l < Pieces.length; l++) {
                                if (Assignments[event.data.File] == Pieces[l].Identifier) {
                                    Pieces[l].assigned = false;
                                    break;
                                }
                            }
                        }
                        Assignments[event.data.File] = Pieces[k].Identifier;
                        Pieces[k].assigned = true;
                        populateAvailablePieces();
                        break;
                    }
                });
            }
        }
        for (var i = 0; i < 2; i++) {
            var layout = '';
            for (var j = 0; j < rookList.length; j++) {
                layout += '<div class="selectpiece" id="sr'+i+'-'+j+'"><img class="selectpieceimg" src="/img/'+imageNameForKind(rookList[j].Kind, 64, o.WHITE)+'"></div>';
            }
            var pick;
            if (i == 0) {
                pick = 0;
            } else {
                pick = 7;
            }
            if (rookList.length == 0) {
                $('#pickback'+pick).html('').addClass('noselect');
            } else {
                $('#pickback'+pick).html(layout).removeClass('noselect');
            }
            for (var j = 0; j < rookList.length; j++) {
                $('#sr'+i+'-'+j).click({Index: j, File: (pick+8)}, function(event) {
                    for (var k = 0; k < Pieces.length; k++) {
                        if (Pieces[k].Identifier != rookList[event.data.Index].Identifier) {
                            continue;
                        }
                        if (Assignments[event.data.File] != 0) {
                            for (var l = 0; l < Pieces.length; l++) {
                                if (Assignments[event.data.File] == Pieces[l].Identifier) {
                                    Pieces[l].assigned = false;
                                    break;
                                }
                            }
                        }
                        Assignments[event.data.File] = Pieces[k].Identifier;
                        Pieces[k].assigned = true;
                        populateAvailablePieces();
                        break;
                    }
                });
            }
        }
        for (var i = 0; i < 2; i++) {
            var layout = '';
            for (var j = 0; j < knightList.length; j++) {
                layout += '<div class="selectpiece" id="sk'+i+'-'+j+'"><img class="selectpieceimg" src="/img/'+imageNameForKind(knightList[j].Kind, 64, o.WHITE)+'"></div>';
            }
            var pick;
            if (i == 0) {
                pick = 1;
            } else {
                pick = 6;
            }
            if (knightList.length == 0) {
                $('#pickback'+pick).html('').addClass('noselect');
            } else {
                $('#pickback'+pick).html(layout).removeClass('noselect');
            }
            for (var j = 0; j < knightList.length; j++) {
                $('#sk'+i+'-'+j).click({Index: j, File: (pick+8)}, function(event) {
                    for (var k = 0; k < Pieces.length; k++) {
                        if (Pieces[k].Identifier != knightList[event.data.Index].Identifier) {
                            continue;
                        }
                        if (Assignments[event.data.File] != 0) {
                            for (var l = 0; l < Pieces.length; l++) {
                                if (Assignments[event.data.File] == Pieces[l].Identifier) {
                                    Pieces[l].assigned = false;
                                    break;
                                }
                            }
                        }
                        Assignments[event.data.File] = Pieces[k].Identifier;
                        Pieces[k].assigned = true;
                        populateAvailablePieces();
                        break;
                    }
                });
            }
        }
        for (var i = 0; i < 2; i++) {
            var layout = '';
            for (var j = 0; j < bishopList.length; j++) {
                layout += '<div class="selectpiece" id="sb'+i+'-'+j+'"><img class="selectpieceimg" src="/img/'+imageNameForKind(bishopList[j].Kind, 64, o.WHITE)+'"></div>';
            }
            var pick;
            if (i == 0) {
                pick = 2;
            } else {
                pick = 5;
            }
            if (bishopList.length == 0) {
                $('#pickback'+pick).html('').addClass('noselect');
            } else {
                $('#pickback'+pick).html(layout).removeClass('noselect');
            }
            for (var j = 0; j < bishopList.length; j++) {
                $('#sb'+i+'-'+j).click({Index: j, File: (pick+8)}, function(event) {
                    for (var k = 0; k < Pieces.length; k++) {
                        if (Pieces[k].Identifier != bishopList[event.data.Index].Identifier) {
                            continue;
                        }
                        if (Assignments[event.data.File] != 0) {
                            for (var l = 0; l < Pieces.length; l++) {
                                if (Assignments[event.data.File] == Pieces[l].Identifier) {
                                    Pieces[l].assigned = false;
                                    break;
                                }
                            }
                        }
                        Assignments[event.data.File] = Pieces[k].Identifier;
                        Pieces[k].assigned = true;
                        populateAvailablePieces();
                        break;
                    }
                });
            }
        }
        // no kings or queens yet
        $('#pickback3').addClass('noselect');
        $('#pickback4').addClass('noselect');
        for (var i = 0; i < 8; i++) {
            if (Assignments[i] != 0) {
                $('#pawn'+(i+8)).click({Index: i, Piece: Assignments[i]}, function(event) {
                    for (var j = 0; j < Pieces.length; j++) {
                        if (Pieces[j].Identifier == event.data.Piece) {
                            Assignments[event.data.Index] = 0;
                            Pieces[j].assigned = false;
                            populateAvailablePieces();
                            break;
                        }
                    }
                });
            }
            if (Assignments[i+8] != 0) {
                $('#back'+i).click({Index: i+8, Piece: Assignments[i+8]}, function(event) {
                    for (var j = 0; j < Pieces.length; j++) {
                        if (Pieces[j].Identifier == event.data.Piece) {
                            Assignments[event.data.Index] = 0;
                            Pieces[j].assigned = false;
                            populateAvailablePieces();
                            break;
                        }
                    }
                });
            }
        }
    }
    $(document).ready(function() {
        layout($(window).width(), $(window).height());
        clickMode(StoredMode);
        jQuery.get('pieces').done(function(data) {
            Pieces = data;
            for (var i = 0; i < Pieces.length; i++) {
                Pieces[i].assigned = false;
            }
            populateAvailablePieces();
        });
    });
    </script>
</head>
<body></body>
</html>
