<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>wichess game</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/body.css">
    <style>
    div {
        text-align: center;
        margin: 0 auto;
    }
    .inlinediv {
        display: inline-block;
        margin: 1em;
    }
    table {
        table-layout: fixed;
        border-collapse: collapse;
        margin: 0 auto;
    }
    #grid {
        outline: 7px outset #d4cca5;
    }
    #check {
        float: left;
    }
    #checkmate {
        float: right;
    }
    tr {
        height: 54px;
    }
    .point {
        width: 54px;
        background-color: white;
    }
    .even {
        background-color: #e1e1e1;
    }
    .odd {
        background-color: #f3f3f3;
    }
    .promotion {
        margin: 1em;
    }
    .promb {
        font-size: 11px;
    }
    .pieceimg {
        width: 48px;
        height: 48px;
    }
    .hovered {
        outline: 2px solid #fb835e;
        outline-offset: -1px;
    }
    .hoveredopp {
        outline: 2px dotted #fb835e;
        outline-offset: -1px;
    }
    .selected {
        outline: 2px solid #fb835e;
        outline-offset: -1px;
    }
    .selectedopp {
        outline: 2px dotted #fb835e;
        outline-offset: -1px;
    }
    span {
        padding: 1em;
    }
    .indicator {
        border-radius: 10px;
        border: 2px solid #d4cca5;
        background-color: #cc785c;
        color: #fb835e;
        margin: 1em;
        /* https://stackoverflow.com/questions/826782/how-to-disable-text-selection-highlighting-using-css */
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
        cursor: default;
    }
    .indicating {
        background-color: #d4cca5;
        color: #825444;
    }
    input {
        border-radius: 5px;
        box-shadow: 0px 1px 1px black;
        margin: 1em;
    }
    .clock {
        border-radius: 10px;
        border: 2px solid #d4cca5;
        background-color: #cc785c;
        color: #fb835e;
        margin: 1em;
        padding: 0.5em;
        font-family: 'Inconsolata', monospace;
    }
    .clocking {
        background-color: #d4cca5;
        color: #825444;
    }
    </style>
    <script type="text/javascript" src="/js/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="/js/moment.min.js"></script>
    <script type="text/javascript" src="/js/duration.js"></script>
    <script type="text/javascript" src="/js/pieces.js"></script>
    <script type="text/javascript">
    var game_id = {{.ID}};
    var Player = {{.Name}};

    var TotalTime = Duration.parse({{.TotalTime}});
    var TurnTime = Duration.parse({{.TurnTime}});
    var NowTime = moment({{.NowTime}});

    var WhiteLatestMove = moment({{.WhiteLatestMove}});
    var WhiteElapsed = Duration.parse({{.WhiteElapsed}});
    var BlackLatestMove = moment({{.BlackLatestMove}});
    var BlackElapsed = Duration.parse({{.BlackElapsed}});

    var NowDifference = moment.duration(moment().diff(NowTime));

    var PlayerOrientation;
    var Opponent = '';
    var White = '';
    var Black = '';
    var Turn = '';

    var Board = null;
    var Selected = null;
    var Moves = null;

    var EasyComputer = 'Easy Computer Player';
    var HardComputer = 'Hard Computer Player';

    var WhiteTimer, BlackTimer;

    var ws = new WebSocket("ws://localhost:8080/moven/"+game_id);
    ws.onmessage = function(event) {
        makeMove(JSON.parse(event.data));
    }
    function setPieceImage(index, kind, orientation) {
        $('#point'+index).html('<img class="pieceimg" src="/img/'+imageNameForKind(kind, index, orientation)+'">');
    }
    function unsetPieceImage(index) {
        $('#point'+index).html('');
    }
    function requestMove(from, to) {
        $.post('/move/'+game_id, {From: from, To: to}).done(makeMove);
    }
    var promotionButtons = '<input type="button" class="promb" value="Queen" onclick="promote('+k.QUEEN+');"/> <input type="button" class="promb" value="Rook" onclick="promote('+k.ROOK+');"/> <input type="button" class="promb" value="Bishop" onclick="promote('+k.BISHOP+');"/> <input type="button" class="promb" value="Knight" onclick="promote('+k.KNIGHT+');"/>';
    function promote(kind) {
        var from = 0;
        if (Player == White) {
            for (var i = 56; i < 64; i++) {
                var piece = Board[i];
                if ((piece.Kind == k.PAWN) && (piece.Orientation == o.WHITE)) {
                    from = i;
                    break;
                }
            }
        } else {
            for (var i = 0; i < 8; i++) {
                var piece = Board[i];
                if ((piece.Kind == k.PAWN) && (piece.Orientation == o.BLACK)) {
                    from = i;
                    break;
                }
            }
        }
        $.post('/move/'+game_id, {From: from, Kind: kind}).done(makeMove);
    }
    function makeMove(diff) {
        if (Object.keys(diff).length > 0) {
            if (TurnTime.milliseconds() > 0) {
                if (Turn == o.WHITE) {
                    clearInterval(WhiteTimer);
                    $('#whiteclock').removeClass('clocking').html(millisecondsToClock(TurnTime.valueOf()-1000));
                    $('#blackclock').addClass('clocking');
                    WhiteLatestMove = moment();
                    BlackTimer = setInterval(function() {
                        updateClock(o.BLACK);
                    }, 1000);
                } else {
                    clearInterval(BlackTimer);
                    $('#blackclock').removeClass('clocking').html(millisecondsToClock(TurnTime.valueOf()-1000));
                    $('#whiteclock').addClass('clocking');
                    BlackLatestMove = moment();
                    WhiteTimer = setInterval(function() {
                        updateClock(o.WHITE);
                    }, 1000);
                }
            } else if (TotalTime.milliseconds() > 0) {
                if (Turn == o.WHITE) {
                    if (NowTime.isAfter(BlackLatestMove)) {
                        WhiteElapsed = Duration.parse((WhiteElapsed.milliseconds() + moment().diff(NowTime).valueOf())+'ms');
                    } else {
                        WhiteElapsed = Duration.parse((WhiteElapsed.milliseconds() + moment().diff(BlackLatestMove))+'ms');
                    }
                    clearInterval(WhiteTimer);
                    $('#whiteclock').removeClass('clocking');
                    $('#blackclock').addClass('clocking');
                    WhiteLatestMove = moment();
                    BlackTimer = setInterval(function() {
                        updateClock(o.BLACK);
                    }, 1000);
                } else {
                    if (NowTime.isAfter(WhiteLatestMove)) {
                        BlackElapsed = Duration.parse((BlackElapsed.milliseconds() + moment().diff(NowTime).valueOf())+'ms');
                    } else {
                        BlackElapsed = Duration.parse((BlackElapsed.milliseconds() + moment().diff(WhiteLatestMove).valueOf())+'ms');
                    }
                    clearInterval(BlackTimer);
                    $('#blackclock').removeClass('clocking');
                    $('#whiteclock').addClass('clocking');
                    BlackLatestMove = moment();
                    WhiteTimer = setInterval(function() {
                        updateClock(o.WHITE);
                    }, 1000);
                }
            }
        }
        for (var point in diff) {
            var index = addrStringToIndex(point);
            if (diff[point].Kind == 0) {
                unsetPieceImage(index);
            } else {
                setPieceImage(index, diff[point].Kind, diff[point].Orientation);
            }
            Board[index] = diff[point];
        }
        $.get('/moves/'+game_id).done(function(data) {
            $('.selected').removeClass('selected');
            $('.hovered').removeClass('hovered');
            $('.hoveredopp').removeClass('hoveredopp');
            Selected = null;
            Moves = data;
            if ('check' in Moves) {
                $('#check').addClass('indicating');
            } else {
                $('#check').removeClass('indicating');
            }
            if ('checkmate' in Moves) {
                if ((TurnTime.milliseconds() > 0) || (TotalTime.milliseconds() > 0)) {
                    clearInterval(WhiteTimer);
                    clearInterval(BlackTimer);
                }
                if (Turn == o.WHITE) {
                    $('#whiteactive').removeClass('indicating');
                    $('#blackactive').addClass('indicating');
                } else {
                    $('#whiteactive').addClass('indicating');
                    $('#blackactive').removeClass('indicating');
                }
                $('#checkmate').addClass('indicating');
                $('#acknowledge').html('<input type="button" value="Acknowledge" onclick="acknowledge();"/>');
                return;
            } else if ('draw' in Moves) {
                if ((TurnTime.milliseconds() > 0) || (TotalTime.milliseconds() > 0)) {
                    clearInterval(WhiteTimer);
                    clearInterval(BlackTimer);
                }
                if (Turn == o.WHITE) {
                    $('#whiteactive').removeClass('indicating');
                    $('#blackactive').addClass('indicating');
                } else {
                    $('#whiteactive').addClass('indicating');
                    $('#blackactive').removeClass('indicating');
                }
                $('#draw').addClass('indicating');
                $('#acknowledge').html('<input type="button" value="Acknowledge" onclick="acknowledge();"/>');
                return;
            } else if ('time' in Moves) {
                clearInterval(BlackTimer);
                clearInterval(WhiteTimer);
                if (Turn == o.WHITE) {
                    $('#whiteactive').removeClass('indicating');
                    $('#blackactive').addClass('indicating');
                } else {
                    $('#whiteactive').addClass('indicating');
                    $('#blackactive').removeClass('indicating');
                }
                $('#time').addClass('indicating');
                $('#acknowledge').html('<input type="button" value="Acknowledge" onclick="acknowledge();"/>');
                return;
            }
            if ('promote' in Moves) {
                if (Turn == PlayerOrientation) {
                    if (White == Player) {
                        $('#whitepromote').html(promotionButtons);
                    } else {
                        $('#blackpromote').html(promotionButtons);
                    }
                }
            } else {
                $('#whitepromote').html('');
                $('#blackpromote').html('');
                if ((Turn == o.WHITE) && (Opponent != EasyComputer) && (Opponent != HardComputer)) {
                    $('#whiteactive').removeClass('indicating');
                    $('#blackactive').addClass('indicating');
                    Turn = o.BLACK;
                } else {
                    $('#whiteactive').addClass('indicating');
                    $('#blackactive').removeClass('indicating');
                    Turn = o.WHITE;
                }
            }
        });

    }
    function addrStringToIndex(str) {
        var address = str.split('-');
        return parseInt(address[0], 10) + (8 * parseInt(address[1], 10))
    }
    function indexToAddrString(i) {
        return (i%8).toString() + '-' + (Math.floor(i/8)).toString();
    }
    function millisecondsToClock(m) {
        var hours = Math.floor(m / (60*60*1000));
        if (hours != 0) {
            m -= hours * 60*60*1000;
        }
        var hourStr;
        if (hours < 10) {
            hourStr = '0'+hours;
        } else {
            hourStr = hours;
        }
        var minutes = Math.floor(m / (60*1000));
        if (minutes != 0) {
            m -= minutes * 60*1000;
        }
        var minuteStr;
        if (minutes < 10) {
            minuteStr = '0'+minutes;
        } else {
            minuteStr = minutes;
        }
        var seconds = Math.floor(m / 1000);
        var secondStr;
        if (seconds < 10) {
            secondStr = '0'+seconds;
        } else {
            secondStr = seconds;
        }
        return hourStr+':'+minuteStr+':'+secondStr;
    }
    function updateClock(orientation) {
        var clock, latestMove, elapsed;
        if (orientation == o.WHITE) {
            clock = '#whiteclock';
            latestMove = BlackLatestMove;
            elapsed = WhiteElapsed;
        } else {
            clock = '#blackclock';
            latestMove = WhiteLatestMove;
            elapsed = BlackElapsed;
        }
        var remaining;
        if (TurnTime.milliseconds() > 0) {
            remaining = TurnTime.milliseconds() - moment().subtract(NowDifference).diff(latestMove).valueOf();
        } else if (TotalTime.milliseconds() > 0) {
            if (NowTime.isAfter(latestMove)) {
                remaining = TotalTime.milliseconds() - (elapsed.milliseconds() + moment().diff(NowTime).valueOf());
            } else {
                remaining = TotalTime.milliseconds() - (elapsed.milliseconds() + moment().diff(latestMove).valueOf());
            }
        }
        $(clock).html(millisecondsToClock(remaining));
    }
    $(document).ready(function() {
        if (TotalTime.milliseconds() > 0) {
            $('#backbutton').hide();
        } else {
            $('#time').hide();
        }
        var board = '';
        board += '<table id="grid">';
        for (var yrr = 7; yrr >= 0; yrr--) {
            board += '<tr>';
            for (var xcf = 0; xcf < 8; xcf++) {
                board += '<td id="point'+(xcf+(yrr*8))+'" class="point"></td>';
            }
            board += '</tr>';
        }
        board += '</table>';
        $('#board').html(board);
        for (var i = 0; i < 64; i++) {
            var y = Math.floor(i / 8);
            var x = i % 8;
            if ((y%2) == 0) {
                if ((x%2) == 0) {
                    $('#point'+i).addClass('even');
                } else {
                    $('#point'+i).addClass('odd');
                }
            } else {
                if ((x%2) == 0) {
                    $('#point'+i).addClass('odd');
                } else {
                    $('#point'+i).addClass('even');
                }
            }
        }
        $.get('/games/'+game_id).done(function(data) {
            Board = data.Points;
            White = data.White;
            Black = data.Black;
            if (White == Player) {
                Opponent = Black;
                PlayerOrientation = o.WHITE;
                $('#youwhite').html('> ');
            } else {
                Opponent = White;
                PlayerOrientation = o.BLACK;
                $('#youblack').html('> ');
            }
            if (data.Active == White) {
                Turn = o.WHITE;
                $('#whiteactive').addClass('indicating');
            } else {
                Turn = o.BLACK;
                $('#blackactive').addClass('indicating');
            }
            if (TurnTime.milliseconds() > 0) {
                if (Turn == o.WHITE) {
                    $('#blackclock').html(millisecondsToClock(TurnTime.valueOf()-1000)).addClass('clock');
                    updateClock(o.WHITE);
                    $('#whiteclock').addClass('clock clocking');
                    WhiteTimer = setInterval(function() {
                        updateClock(o.WHITE);
                    }, 1000);
                } else {
                    $('#whiteclock').html(millisecondsToClock(TurnTime.valueOf()-1000)).addClass('clock');
                    updateClock(o.BLACK);
                    $('#blackclock').addClass('clock clocking');
                    BlackTimer = setInterval(function() {
                        updateClock(o.BLACK);
                    }, 1000);            
                }
            } else if (TotalTime.milliseconds() > 0) {
                var btime = TotalTime.milliseconds()-BlackElapsed.milliseconds()-1000;
                if (btime < 0) {
                    btime = 0;
                }
                var wtime = TotalTime.milliseconds()-WhiteElapsed.milliseconds()-1000;
                if (wtime < 0) {
                    wtime = 0;
                }
                $('#blackclock').html(millisecondsToClock(btime)).addClass('clock');
                $('#whiteclock').html(millisecondsToClock(wtime)).addClass('clock');
                if (Turn == o.WHITE) {
                    $('#whiteclock').addClass('clock clocking');
                    WhiteTimer = setInterval(function() {
                        updateClock(o.WHITE);
                    }, 1000);
                } else {
                    $('#blackclock').addClass('clock clocking');
                    BlackTimer = setInterval(function() {
                        updateClock(o.BLACK);
                    }, 1000);
                }
            }
            for (var i = 0; i < Board.length; i++) {
                if (Board[i].Kind == 0) {
                    continue;
                } else {
                    setPieceImage(i, Board[i].Kind, Board[i].Orientation);
                }
            }
            $.get('/moves/'+game_id).done(function(data) {
                Moves = data;
                if ('check' in Moves) {
                    $('#check').addClass('indicating');
                } else {
                    $('#check').removeClass('indicating');
                }
                if ('checkmate' in Moves) {
                    if ((TurnTime.milliseconds() > 0) || (TotalTime.milliseconds() > 0)) {
                        clearInterval(BlackTimer);
                        clearInterval(WhiteTimer);
                    }
                    $('#checkmate').addClass('indicating');
                    $('#acknowledge').html('<input type="button" value="Acknowledge" onclick="acknowledge();"/>');
                } else if ('draw' in Moves) {
                if ((TurnTime.milliseconds() > 0) || (TotalTime.milliseconds() > 0)) {
                        clearInterval(BlackTimer);
                        clearInterval(WhiteTimer);
                    }
                    $('#draw').addClass('indicating');
                    $('#acknowledge').html('<input type="button" value="Acknowledge" onclick="acknowledge();"/>');
                } else if ('time' in Moves) {
                    clearInterval(BlackTimer);
                    clearInterval(WhiteTimer);
                    $('#time').addClass('indicating');
                    $('#acknowledge').html('<input type="button" value="Acknowledge" onclick="acknowledge();"/>');
                }
                if ('promote' in Moves) {
                    if (Turn == PlayerOrientation) {
                        if (White == Player) {
                            $('#whitepromote').html(promotionButtons);
                        } else {
                            $('#blackpromote').html(promotionButtons);
                        }
                    }
                } else {
                    $('#whitepromote').html('');
                    $('#blackpromote').html('');
                }
                for (var i = 0; i < 64; i++) {
                    $('#point'+i).click({Index: i}, function(event) {
                        var index = event.data.Index;
                        var className = '';
                        if ((Selected != index) && ($('#point'+index).hasClass('selected'))) {
                            if (Turn == PlayerOrientation) {
                                requestMove(Selected, index);
                            }
                            return;
                        }
                        if (Board[index].Kind == 0) {
                            return;
                        }
                        if (Moves[indexToAddrString(index)] == null) {
                            return;
                        }
                        if (Selected != null) {
                            if (Board[Selected].Orientation == PlayerOrientation) {
                                className = 'selected';
                            } else {
                                className = 'selectedopp';
                            }
                            $('#point'+Selected).removeClass(className);
                            for (var point in Moves[indexToAddrString(Selected)]) {
                                $('#point'+addrStringToIndex(point)).removeClass(className);
                            }
                            if (Selected == index) {
                                Selected = null;
                                return;
                            }
                        }
                        if (Board[index].Orientation == PlayerOrientation) {
                            className = 'selected';
                        } else {
                            className = 'selectedopp';
                        }
                        $('#point'+index).addClass(className);
                        for (var point in Moves[indexToAddrString(index)]) {
                            $('#point'+addrStringToIndex(point)).addClass(className);
                        }
                        Selected = index;
                    }).mouseenter({Index: i}, function(event) {
                        var index = event.data.Index;
                        var className;
                        if (Board[index].Kind == 0) {
                            return;
                        }
                        if (Moves[indexToAddrString(index)] == null) {
                            return;
                        }
                        if (Board[index].Orientation == PlayerOrientation) {
                            className = 'hovered';
                        } else {
                            className = 'hoveredopp';
                        }
                        $('#point'+index).addClass(className);
                        for (var point in Moves[indexToAddrString(index)]) {
                            $('#point'+addrStringToIndex(point)).addClass(className);
                        }
                    }).mouseleave({Index: i}, function(event) {
                        var index = event.data.Index;
                        var className;
                        if (Board[index].Kind == 0) {
                            return;
                        }
                        if (Moves[indexToAddrString(index)] == null) {
                            return;
                        }
                        if (Board[index].Orientation == PlayerOrientation) {
                            className = 'hovered';
                        } else {
                            className = 'hoveredopp';
                        }
                        $('#point'+index).removeClass(className);
                        for (var point in Moves[indexToAddrString(index)]) {
                            $('#point'+addrStringToIndex(point)).removeClass(className);
                        }
                    });
                }
            });
        });
    });
    function acknowledge() {
        jQuery.post('/acknowledge', {
            player: Player,
            gameid: game_id
        }).done(function() {
            window.location.pathname = '/';
        });
    }
    </script>
</head>

<body>
    <div>
        <div id="blackclock" class="inlinediv"></div>
        <div class="inlinediv"><span id="youblack"></span><span>{{.Black}}</span></div>
        <div class="inlinediv"><span class="indicator" id="blackactive">Turn</span></div>
        <div id="whitepromote" class="promotion"></div>
    </div>
    <div>
        <table><tr>
            <td><table><tr><td><span class="indicator" id="check">Check</span></td></tr>
                <tr><td><input id="backbutton" type="button" value="Back" onclick="window.location.pathname = '/';"/></td></tr></table></td>
            <td><div id="board"></div></td>
            <td><table>
                <tr><td><span class="indicator" id="draw">Draw</span></td></tr>
                <tr><td><span class="indicator" id="checkmate">Checkmate</span></td></tr>
                <tr><td><span class="indicator" id="time">Time</span></td></tr>
                <tr><td id="acknowledge"></td></tr>
            </table></td>
            <td></td>
        </tr></table>
    </div>
    <div>
        <div id="blackpromote" class="promotion"></div>
        <div id="whiteclock" class="inlinediv"></div>
        <div class="inlinediv"><span id="youwhite"></span><span>{{.White}}</span></div>
        <div class="inlinediv"><span class="indicator" id="whiteactive">Turn</span></div>
    </div>
</body>
</html>
