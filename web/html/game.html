<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>wichess game</title>
    <style>
    div {
        text-align: center;
        margin: 0 auto;
        width: 100%;
    }
    table {
        table-layout: fixed;
        border-collapse: collapse;
        width: 512px;
        margin: 0 auto;
    }
    tr {
        height: 66px;
    }
    .point {
        width: 66px;
        border: 1px solid #f4f4f4;
    }
    .spacer {
        height: 20px;
    }
    .pieceimg {
        width: 64px;
        height: 64px;
    }
    .hovered {
        outline: 2px solid black;
        outline-offset: -1px;
    }
    .hoveredopp {
        outline: 2px dotted black;
        outline-offset: -1px;
    }
    .selected {
        outline: 2px solid black;
        outline-offset: -1px;
    }
    .selectedopp {
        outline: 2px dotted black;
        outline-offset: -1px;
    }
    </style>
    <script type="text/javascript" src="/js/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="/js/pieces.js"></script>
    <script type="text/javascript">
    var game_id = {{.GameID}};
    var Player = {{.Name}};
    var PlayerOrientation;
    var Opponent = '';
    var White = '';
    var Black = '';
    var Turn = '';
    var Board = null;
    var Selected = null;
    var Moves = null;
    var ws = new WebSocket("ws://localhost:8080/moven/"+game_id);
    ws.onmessage = function(event) {
        makeMove(JSON.parse(event.data));
    }
    function setPieceImage(index, kind, orientation) {
        $('#point'+index).html('<img class="pieceimg" src="img/'+imageNameForKind(kind, index, orientation)+'">');
    }
    function unsetPieceImage(index) {
        $('#point'+index).html('');
    }
    function getMoves() {
        $.get('/moves/'+game_id).done(function(data) {
            Moves = data;
        });
    }
    function requestMove(from, to) {
        $.post('/move/'+game_id, {From: from, To: to}).done(makeMove);
    }
    function makeMove(diff) {
        for (var point in diff) {
            var index = addrStringToIndex(point);
            if (diff[point].Kind == 0) {
                unsetPieceImage(index);
            } else {
                setPieceImage(index, diff[point].Kind, diff[point].Orientation);
            }
            Board[index] = diff[point];
        }
        $.get('/moves/'+game_id).done(function(data) {
            $('.selected').removeClass('selected');
            $('.hovered').removeClass('hovered');
            $('.hoveredopp').removeClass('hoveredopp');
            Selected = null;
            Moves = data;
        });
        if (Turn == o.WHITE) {
            $('#whiteactive').html('');
            $('#blackactive').html('*');
            Turn = o.BLACK;
        } else {
            $('#whiteactive').html('*');
            $('#blackactive').html('');
            Turn = o.WHITE;
        }
    }
    function addrStringToIndex(str) {
        var address = str.split('-');
        return parseInt(address[0], 10) + (8 * parseInt(address[1], 10))
    }
    function indexToAddrString(i) {
        return (i%8).toString() + '-' + (Math.floor(i/8)).toString();
    }
    $(document).ready(function() {
        var board = '';
        board += '<table id="grid">';
        for (var yrr = 7; yrr >= 0; yrr--) {
            board += '<tr>';
            for (var xcf = 0; xcf < 8; xcf++) {
                board += '<td id="point'+(xcf+(yrr*8))+'" class="point"></td>';
            }
            board += '</tr>';
        }
        board += '</table>';
        $('#board').html(board);
        $.get('/games/'+game_id).done(function(data) {
            Board = data.Points;
            White = data.White;
            Black = data.Black;
            if (White == Player) {
                Opponent = Black;
                PlayerOrientation = o.WHITE;
                $('#youwhite').html('You -> ');
            } else {
                Opponent = White;
                PlayerOrientation = o.BLACK;
                $('#youblack').html('You -> ');
            }
            if (data.Active == White) {
                Turn = o.WHITE;
                $('#whiteactive').html('*');
            } else {
                Turn = o.BLACK;
                $('#blackactive').html('*');
            }
            for (var i = 0; i < Board.length; i++) {
                if (Board[i].Kind == 0) {
                    continue;
                } else {
                    setPieceImage(i, Board[i].Kind, Board[i].Orientation);
                }
            }
        });
        $.get('/moves/'+game_id).done(function(data) {
            Moves = data;
            for (var i = 0; i < 64; i++) {
                $('#point'+i).click({Index: i}, function(event) {
                    var index = event.data.Index;
                    var className = '';
                    if ((Selected != index) && ($('#point'+index).hasClass('selected'))) {
                        if (Turn == PlayerOrientation) {
                            requestMove(Selected, index);
                        }
                        return;
                    }
                    if (Board[index].Kind == 0) {
                        return;
                    }
                    if (Moves[indexToAddrString(index)] == null) {
                        return;
                    }
                    if (Selected != null) {
                        if (Board[Selected].Orientation == PlayerOrientation) {
                            className = 'selected';
                        } else {
                            className = 'selectedopp';
                        }
                        $('#point'+Selected).removeClass(className);
                        for (var point in Moves[indexToAddrString(Selected)]) {
                            $('#point'+addrStringToIndex(point)).removeClass(className);
                        }
                        if (Selected == index) {
                            Selected = null;
                            return;
                        }
                    }
                    if (Board[index].Orientation == PlayerOrientation) {
                        className = 'selected';
                    } else {
                        className = 'selectedopp';
                    }
                    $('#point'+index).addClass(className);
                    for (var point in Moves[indexToAddrString(index)]) {
                        $('#point'+addrStringToIndex(point)).addClass(className);
                    }
                    Selected = index;
                }).mouseenter({Index: i}, function(event) {
                    var index = event.data.Index;
                    var className;
                    if (Board[index].Kind == 0) {
                        return;
                    }
                    if (Moves[indexToAddrString(index)] == null) {
                        return;
                    }
                    if (Board[index].Orientation == PlayerOrientation) {
                        className = 'hovered';
                    } else {
                        className = 'hoveredopp';
                    }
                    $('#point'+index).addClass(className);
                    for (var point in Moves[indexToAddrString(index)]) {
                        $('#point'+addrStringToIndex(point)).addClass(className);
                    }
                }).mouseleave({Index: i}, function(event) {
                    var index = event.data.Index;
                    var className;
                    if (Board[index].Kind == 0) {
                        return;
                    }
                    if (Moves[indexToAddrString(index)] == null) {
                        return;
                    }
                    if (Board[index].Orientation == PlayerOrientation) {
                        className = 'hovered';
                    } else {
                        className = 'hoveredopp';
                    }
                    $('#point'+index).removeClass(className);
                    for (var point in Moves[indexToAddrString(index)]) {
                        $('#point'+addrStringToIndex(point)).removeClass(className);
                    }
                });
            }
        });
    });
    </script>
</head>

<body>
    <div class="spacer"></div>
    <div><span id="youblack"></span><span>{{.Black}}</span><span id="blackactive"></span></div>
    <div class="spacer"></div>
    <div id="board"></div>
    <div class="spacer"></div>
    <div><span id="youwhite"></span><span>{{.White}}</span><span id="whiteactive"></span></div>
</body>
</html>
