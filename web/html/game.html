<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>wichess game</title>
    <!-- Copyright 2017 Matthew Juran -->
    <!-- All Rights Reserved -->
    <meta name="apple-mobile-web-app-capable" content="yes">    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <style>
    body {
        background-color: #cc785c;
        margin: 0px;
        border: 0px;
        padding: 0px;
        font-family: 'Libre Baskerville', serif;
        color: #d4cca5;
    }
    .inline {
        display: inline-block;
        vertical-align: top;
    }
    table {
        border: 7px outset #d4cca5;
        border-spacing: 0px;
    }
    tr {
        border: 0px;
    }
    td {
        padding: 0px;
    }
    .even {
        background-color: #e1e1e1;
    }
    .odd {
        background-color: #f3f3f3;
    }
    #state {
        border: 5px solid #cc785c;
        text-align: center;
        border-radius: 10px;
        background-color: #cc785c;
        color: #fb835e;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
        cursor: default;
    }
    .indicating {
        background-color: #d4cca5 !important;
        color: #825444 !important;
    }
    .player {
        border: 10px solid #cc785c;
        border-radius: 30px;
        text-align: center;
    }
    .button {
        background-color: #fb835e;
        color: #d4cca5;
        text-align: center;
        border-radius: 10px;
        box-shadow: 0px 1px 1px black;
        margin: 0 auto;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
        cursor: default;
    }
    #movesound, #music {
        text-align: center;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
        cursor: default;
    }
    .clock {
        font-family: 'Inconsolata', monospace;
        /* https://stackoverflow.com/questions/826782/how-to-disable-text-selection-highlighting-using-css */
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */
        cursor: default;
    }
    .hovered {
        outline: 2px solid #fb835e;
        outline-offset: -1px;
    }
    .hoveredopp {
        outline: 2px dotted #fb835e;
        outline-offset: -1px;
    }
    .selected {
        outline: 2px solid #fb835e;
        outline-offset: -1px;
    }
    .selectedopp {
        outline: 2px dotted #fb835e;
        outline-offset: -1px;
    }
    .pieceimg, .gainedpieceimg {
        vertical-align: top;
        width: 100%;
        height: 100%;
    }
    </style>
    <script type="text/javascript" src="/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="/js/jquery.fittext.js"></script>
    <script type="text/javascript" src="/js/moment.min.js"></script>
    <script type="text/javascript" src="/js/duration.js"></script>
    <script type="text/javascript" src="/js/pieces.js"></script>
    <script type="text/javascript" src="/js/AudioContextMonkeyPatch.js"></script>
    <script type="text/javascript">
    // https://stackoverflow.com/questions/8788802/prevent-safari-loading-from-cache-when-back-button-is-clicked/13123626#13123626
    // https://stackoverflow.com/questions/17432899/javascript-bfcache-pageshow-event-event-persisted-always-set-to-false
    $(window).bind("pageshow", function(event) {
        if (event.originalEvent.persisted || (window.performance && (window.performance.navigation.type == 2))) {
            window.location.reload();
        }
    });
    // if (width/height) - 1 is within these ratio threshold then the square layout is used, below is vertical, above is horizontal
    var SquareRatioThreshold = 0.3;
    var BottomSquareRatioThreshold = -0.219;
    // space around the board, set as table in the css above
    var BoardPadding = 7;
    var StatePadding = 5;
    var PlayerPadding = 10;

    var states = {
        NONE: 0,
        CHECK: 1,
        DRAW: 2,
        TIME: 3,
        CHECKMATE: 4
    };

    // used to keep the same state on redraw of interface (like on a resize)
    var GameState = states.NONE;

    // client representation of the current board state
    var Board = null;
    var Selected = null;
    var Moves = null;

    var game_id = {{.ID}};
    var Player = {{.Name}};

    var PlayerOrientation;
    var Opponent = '';
    var White = '';
    var Black = '';
    var Turn;

    var TotalTime = Duration.parse({{.TotalTime}});
    var TurnTime = Duration.parse({{.TurnTime}});
    var NowTime = moment({{.NowTime}});

    var WhiteLatestMove = moment({{.WhiteLatestMove}});
    var WhiteElapsed = Duration.parse({{.WhiteElapsed}});
    var BlackLatestMove = moment({{.BlackLatestMove}});
    var BlackElapsed = Duration.parse({{.BlackElapsed}});

    var NowDifference = moment.duration(moment().diff(NowTime));

    var Promoting = false;
    var GainedPiece = null;
    var Acknowledging = false;

    var MoveSoundContext = new AudioContext();
    var MoveSoundSource = null;
    var SoundCount = 325;
    var Muted = false;

    loadNextMoveSound();

    var EasyComputer = 'Easy Computer Player';
    var HardComputer = 'Hard Computer Player';

    var WhiteTimer = null;
    var BlackTimer = null;

    function loadNextMoveSound() {
        MoveSoundSource = MoveSoundContext.createBufferSource();
        MoveSoundSource.connect(MoveSoundContext.destination);
        var request = new XMLHttpRequest();
        request.open('GET', '/sound/click'+Math.floor(Math.random()*SoundCount)+'.wav', true);
        request.responseType = 'arraybuffer';
        request.onload = function() {
            MoveSoundContext.decodeAudioData(request.response, function(buffer) {
                MoveSoundSource.buffer = buffer;
            }, function() {
                console.log('failed to decode audio clip');
            });
        }
        request.send();
    }
    var ws = new WebSocket("ws://localhost:8080/moven/"+game_id);
    ws.onmessage = function(event) {
        makeMove(JSON.parse(event.data));
    }
    function setPieceImage(index, kind, orientation) {
        $('#point'+index).html('<img class="pieceimg" src="/img/'+imageNameForKind(kind, index, orientation)+'">');
    }
    function unsetPieceImage(index) {
        $('#point'+index).html('');
    }
    function requestMove(from, to) {
        $.post('/move/'+game_id, {From: from, To: to}).done(makeMove);
    }
    function promote(kind) {
        var from = 0;
        if (Player == White) {
            for (var i = 56; i < 64; i++) {
                var piece = Board[i];
                if ((piece.Base == k.PAWN) && (piece.Orientation == o.WHITE)) {
                    from = i;
                    break;
                }
            }
        } else {
            for (var i = 0; i < 8; i++) {
                var piece = Board[i];
                if ((piece.Base == k.PAWN) && (piece.Orientation == o.BLACK)) {
                    from = i;
                    break;
                }
            }
        }
        unsetPromoting();
        $.post('/move/'+game_id, {From: from, Kind: kind}).done(makeMove);
    }
    function getMoves() {
        $.get('/moves/'+game_id).done(function(data) {
            $('.selected').removeClass('selected');
            $('.hovered').removeClass('hovered');
            $('.hoveredopp').removeClass('hoveredopp');
            Selected = null;
            Moves = data;
            if ('check' in Moves) {
                setState(states.CHECK);
            } else {
                setState(states.NONE);
            }
            if ('checkmate' in Moves) {
                if ((TurnTime.milliseconds() > 0) || (TotalTime.milliseconds() > 0)) {
                    if (Turn == o.BLACK) {
                        clearInterval(BlackTimer);
                    } else {
                        clearInterval(WhiteTimer);
                    }
                    GainedPiece = parseInt(Object.keys(Moves['checkmate'])[0]);
                    setGainedPiece();
                }
                setState(states.CHECKMATE);
                Acknowledging = true;
                setAcknowledge();
                return;
            } else if ('draw' in Moves) {
                if ((TurnTime.milliseconds() > 0) || (TotalTime.milliseconds() > 0)) {
                    if (Turn == o.BLACK) {
                        clearInterval(BlackTimer);
                    } else {
                        clearInterval(WhiteTimer);
                    }
                    GainedPiece = parseInt(Object.keys(Moves['draw'])[0]);
                    setGainedPiece();
                }
                setState(states.DRAW);
                Acknowledging = true;
                setAcknowledge();
                return;
            } else if ('time' in Moves) {
                if (Turn == o.BLACK) {
                    clearInterval(BlackTimer);
                    $('#blackclock').html(millisecondsToClock(0));
                } else {
                    clearInterval(WhiteTimer);
                    $('#whiteclock').html(millisecondsToClock(0));
                }
                GainedPiece = parseInt(Object.keys(Moves['time'])[0]);
                setGainedPiece();
                setState(states.TIME);
                Acknowledging = true;
                setAcknowledge();
                return;
            }
            if ('promote' in Moves) {
                // makeMove switched Turn to the other player
                if ((Turn != PlayerOrientation) || (Opponent == EasyComputer) || (Opponent == HardComputer)) {
                    setPromoting();
                    Turn = PlayerOrientation;
                    if (Turn == o.WHITE) {
                        $('#white').addClass('indicating');
                        $('#black').removeClass('indicating');
                    } else {
                        $('#black').addClass('indicating');
                        $('#white').removeClass('indicating');
                    }
                } else {
                    if (PlayerOrientation == o.WHITE) {
                        Turn = o.BLACK;
                        $('#white').removeClass('indicating');
                        $('#black').addClass('indicating');
                    } else {
                        Turn = o.WHITE;
                        $('#white').addClass('indicating');
                        $('#black').removeClass('indicating');
                    }
                }
                if (TurnTime.milliseconds() > 0) {
                    if (Turn == o.BLACK) {
                        clearInterval(WhiteTimer);
                        $('#whiteclock').html(millisecondsToClock(TurnTime.valueOf()-1000));
                        WhiteLatestMove = moment();
                        BlackTimer = setInterval(function() {
                            updateClock(o.BLACK);
                        }, 1000);
                    } else {
                        clearInterval(BlackTimer);
                        $('#blackclock').html(millisecondsToClock(TurnTime.valueOf()-1000));
                        BlackLatestMove = moment();
                        WhiteTimer = setInterval(function() {
                            updateClock(o.WHITE);
                        }, 1000);
                    }
                } else if (TotalTime.milliseconds() > 0) {
                    if (Turn == o.BLACK) {
                        if (NowTime.isAfter(BlackLatestMove)) {
                            WhiteElapsed = Duration.parse((WhiteElapsed.milliseconds() + moment().diff(NowTime).valueOf())+'ms');
                        } else {
                            WhiteElapsed = Duration.parse((WhiteElapsed.milliseconds() + moment().diff(BlackLatestMove))+'ms');
                        }
                        clearInterval(WhiteTimer);
                        WhiteLatestMove = moment();
                        BlackTimer = setInterval(function() {
                            updateClock(o.BLACK);
                        }, 1000);
                    } else {
                        if (NowTime.isAfter(WhiteLatestMove)) {
                            BlackElapsed = Duration.parse((BlackElapsed.milliseconds() + moment().diff(NowTime).valueOf())+'ms');
                        } else {
                            BlackElapsed = Duration.parse((BlackElapsed.milliseconds() + moment().diff(WhiteLatestMove).valueOf())+'ms');
                        }
                        clearInterval(BlackTimer);
                        BlackLatestMove = moment();
                        WhiteTimer = setInterval(function() {
                            updateClock(o.WHITE);
                        }, 1000);
                    }
                }
            } else {
                unsetPromoting();
            }
        });
    }
    function makeMove(diff) {
        if (Object.keys(diff).length > 0) {
            if ((Opponent != EasyComputer) && (Opponent != HardComputer)) {
                if (Turn == o.WHITE) {
                    $('#white').removeClass('indicating');
                    $('#black').addClass('indicating');
                    Turn = o.BLACK;
                } else {
                    $('#white').addClass('indicating');
                    $('#black').removeClass('indicating');
                    Turn = o.WHITE;
                }
            }
            if (TurnTime.milliseconds() > 0) {
                if (Turn == o.BLACK) {
                    clearInterval(WhiteTimer);
                    $('#whiteclock').html(millisecondsToClock(TurnTime.valueOf()-1000));
                    WhiteLatestMove = moment();
                    BlackTimer = setInterval(function() {
                        updateClock(o.BLACK);
                    }, 1000);
                } else {
                    clearInterval(BlackTimer);
                    $('#blackclock').html(millisecondsToClock(TurnTime.valueOf()-1000));
                    BlackLatestMove = moment();
                    WhiteTimer = setInterval(function() {
                        updateClock(o.WHITE);
                    }, 1000);
                }
            } else if (TotalTime.milliseconds() > 0) {
                if (Turn == o.BLACK) {
                    if (NowTime.isAfter(BlackLatestMove)) {
                        WhiteElapsed = Duration.parse((WhiteElapsed.milliseconds() + moment().diff(NowTime).valueOf())+'ms');
                    } else {
                        WhiteElapsed = Duration.parse((WhiteElapsed.milliseconds() + moment().diff(BlackLatestMove))+'ms');
                    }
                    clearInterval(WhiteTimer);
                    WhiteLatestMove = moment();
                    BlackTimer = setInterval(function() {
                        updateClock(o.BLACK);
                    }, 1000);
                } else {
                    if (NowTime.isAfter(WhiteLatestMove)) {
                        BlackElapsed = Duration.parse((BlackElapsed.milliseconds() + moment().diff(NowTime).valueOf())+'ms');
                    } else {
                        BlackElapsed = Duration.parse((BlackElapsed.milliseconds() + moment().diff(WhiteLatestMove).valueOf())+'ms');
                    }
                    clearInterval(BlackTimer);
                    BlackLatestMove = moment();
                    WhiteTimer = setInterval(function() {
                        updateClock(o.WHITE);
                    }, 1000);
                }
            }
        }
        for (var point in diff) {
            var index = addrStringToIndex(point);
            if (diff[point].Kind == 0) {
                unsetPieceImage(index);
            } else {
                setPieceImage(index, diff[point].Kind, diff[point].Orientation);
                var dim = Math.floor(($('#board').height() - (2 * BoardPadding)) / 8);
                $('.pieceimg').css('height', dim + 'px').css('width', dim + 'px');
            }
            Board[index] = diff[point];
        }
        getMoves();
        if (Muted == false) {
            MoveSoundSource.start(0);
            loadNextMoveSound();
        }
    }
    function addrStringToIndex(str) {
        var address = str.split('-');
        return parseInt(address[0], 10) + (8 * parseInt(address[1], 10))
    }
    function indexToAddrString(i) {
        return (i%8).toString() + '-' + (Math.floor(i/8)).toString();
    }
    function millisecondsToClock(m) {
        var hours = Math.floor(m / (60*60*1000));
        if (hours != 0) {
            m -= hours * 60*60*1000;
        }
        var hourStr;
        if (hours < 10) {
            hourStr = '0'+hours;
        } else {
            hourStr = hours;
        }
        var minutes = Math.floor(m / (60*1000));
        if (minutes != 0) {
            m -= minutes * 60*1000;
        }
        var minuteStr;
        if (minutes < 10) {
            minuteStr = '0'+minutes;
        } else {
            minuteStr = minutes;
        }
        var seconds = Math.floor(m / 1000);
        var secondStr;
        if (seconds < 10) {
            secondStr = '0'+seconds;
        } else {
            secondStr = seconds;
        }
        return hourStr+':'+minuteStr+':'+secondStr;
    }
    function updateClock(orientation) {
        var clock, latestMove, elapsed;
        if (orientation == o.WHITE) {
            clock = '#whiteclock';
            latestMove = BlackLatestMove;
            elapsed = WhiteElapsed;
        } else {
            clock = '#blackclock';
            latestMove = WhiteLatestMove;
            elapsed = BlackElapsed;
        }
        var remaining;
        if (TurnTime.milliseconds() > 0) {
            remaining = TurnTime.milliseconds() - moment().subtract(NowDifference).diff(latestMove).valueOf();
        } else if (TotalTime.milliseconds() > 0) {
            if (NowTime.isAfter(latestMove)) {
                remaining = TotalTime.milliseconds() - (elapsed.milliseconds() + moment().diff(NowTime).valueOf());
            } else {
                remaining = TotalTime.milliseconds() - (elapsed.milliseconds() + moment().diff(latestMove).valueOf());
            }
        }
        $(clock).html(millisecondsToClock(remaining));
    }
    function setAcknowledge() {
        if (Acknowledging == false) {
            return;
        }
        $('#acknowledge').html('<div id="aspacer"></div><div class="button" id="ackbutton">Acknowledge</div>');
        $('#aspacer').css('height', '10%');
        $('#ackbutton').css('width', '90%').css('height', '80%').css('line-height', $('#ackbutton').height() + 'px').fitText();
        $('#ackbutton').click(function() {
            jQuery.post('/acknowledge', {
                player: Player,
                gameid: game_id
            }).done(function() {
                window.location.pathname = '/';
            });
        });
    }
    function setGainedPiece() {
        if (GainedPiece == null) {
            return;
        }
        $('#promote').html(`
            <div id="gainimg"><img id="gainedpieceimg" src="/img/`+imageNameForKind(GainedPiece, 64, PlayerOrientation)+`"></div><!--
            --><div id="gaintext">+`+nameForKind(GainedPiece)+`</div>
        `);
        $('#gainimg').css('height', ($('#promote').height() * (5/6)) + 'px').css('width', '100%');
        var dim;
        if ($('#gainimg').height() < $('#gainimg').width()) {
            dim = $('#gainimg').height();
        } else {
            dim = $('#gainimg').width();
        }
        $('#gainedpieceimg').css('height', dim + 'px').css('width', dim + 'px').css('margin', '0 auto').css('display', 'block');
        $('#gaintext').css('height', ($('#promote').height() * (1/6)) + 'px').css('width', '100%').css('text-align', 'center').fitText(2);
    }
    function unsetPromoting() {
        Promoting = false;
        $('#promote').html('');
    }
    function setPromoting() {
        Promoting = true;
        $('#promote').html(`
            <div class="inline"><!--
                --><div class="promotediv"><!--
                    --><div class="prspacer"></div><!--
                    --><div class="button" id="queenpromote">Queen</div><!--
                --></div><!--
                --><div class="promotediv"><!--
                    --><div class="prspacer"></div><!--
                    --><div class="button" id="bishoppromote">Bishop</div><!--
                --></div><!--
            --></div><!--
            --><div class="inline"><!--
                --><div class="promotediv"><!--
                    --><div class="prspacer"></div><!--
                    --><div class="button" id="rookpromote">Rook</div><!--
                --></div><!--
                --><div class="promotediv"><!--
                    --><div class="prspacer"></div><!--
                    --><div class="button" id="knightpromote">Knight</div><!--
                --></div><!--
            --></div>
        `);
        $('.promotediv').css('width', ($('#promote').width() / 2) + 'px').css('height', ($('#promote').height() / 2) + 'px');
        $('.prspacer').css('height', '10%');
        $('#queenpromote, #bishoppromote, #rookpromote, #knightpromote').css('width', '80%').css('height', '80%').css('line-height', $('#queenpromote').height() + 'px').fitText(0.5);
        $('#queenpromote').click(function() {promote(k.QUEEN)});
        $('#bishoppromote').click(function() {promote(k.BISHOP)});
        $('#rookpromote').click(function() {promote(k.ROOK)});
        $('#knightpromote').click(function() {promote(k.KNIGHT)});
    }
    function setState(state) {
        GameState = state;
        switch (state) {
            case states.NONE:
                $('#state').html('wichess!').removeClass('indicating');
                break;
            case states.CHECK:
                $('#state').html('Check').addClass('indicating');
                break;
            case states.DRAW:
                $('#state').html('Draw').addClass('indicating');
                break;
            case states.TIME:
                $('#state').html('Time').addClass('indicating');
                break;
            case states.CHECKMATE:
                $('#state').html('Checkmate').addClass('indicating');
                break;
        }
        $('#state').fitText();
        $('#state').css('line-height', $('#state').height()  + 'px');
    }
    function layout(width, height) {
        if (WhiteTimer != null) {
            clearInterval(WhiteTimer);
        }
        if (BlackTimer != null) {
            clearInterval(BlackTimer);
        }
        var blackTime = '';
        var whiteTime = '';
        if ((TurnTime.milliseconds() > 0) || (TotalTime.milliseconds() > 0)) {
            blackTime = $('#blackclock').html();
            whiteTime = $('#whiteclock').html();
        }
        // square layout
        if ((((width/height)-1) < SquareRatioThreshold) && (((width/height) - 1) > BottomSquareRatioThreshold)) {
            var page = `
                <div class="inline"><!--
                    --><div id="promote"></div><!--
                    --><div id="players"></div><!--
                    --><div id="state"></div><!--
                --></div><!--
                --><div class="inline"><!--
                    --><div><!--
                        --><div class="inline" id="acknowledge"></div><!--
                        --><div class="inline" id="soundback"></div><!--
                    --></div><!--
                    --><div id="board"></div><!--
                --></div>
            `;
            $('#body').html(page);
            var boardDim;
            if (width > height) {
                boardDim = height * (5/6);
            } else {
                boardDim = width * (5/6);
            }
            $('#board').css('width', boardDim + 'px').css('height', boardDim + 'px');
            var remainingWidth = width - boardDim;
            var remainingHeight = height - boardDim;
            $('#state').css('width', (remainingWidth - (2 * StatePadding)) + 'px').css('height', ((height / 4) - (2 * StatePadding)) + 'px');
            $('#players').css('width', remainingWidth + 'px').css('height', (height / 2) + 'px');
            $('#promote').css('width', remainingWidth + 'px').css('height', (height / 4) + 'px');
            $('#acknowledge').css('width', (boardDim / 2) + 'px').css('height', remainingHeight + 'px');
            $('#soundback').css('width', (boardDim / 2) + 'px').css('height', remainingHeight + 'px');
            if ((TotalTime.milliseconds() > 0) || (TurnTime.milliseconds() > 0)) {
                $('#players').html(`
                    <div id="black" class="player">
                        <div id="blackname"></div>
                        <div id="blackclock" class="clock"></div>
                    </div>
                    <div id="white" class="player">
                        <div id="whitename"></div>
                        <div id="whiteclock" class="clock"></div>
                    </div>
                `);

            } else {
                $('#players').html(`
                    <div id="black" class="player"></div>
                    <div id="white" class="player"></div>
                `);
            }
            $('.player').css('height', (($('#players').height() / 2) - (PlayerPadding * 2)) + 'px').css('width', ($('#players').width() - (PlayerPadding * 2)) + 'px');
            if (TotalTime.milliseconds() > 0) {
                $('#soundback').html(`
                    <div class="inline" id="movesound">&#x1f50a;</div><!--
                    --><div class="inline" id="music">&#9835;</div>
                `);
                $('#movesound, #music').css('width', ($('#soundback').width() / 2) + 'px').css('height', $('#soundback').height() + 'px').css('line-height', $('#movesound').height() + 'px').fitText(0.4);
            } else {
                $('#soundback').html(`
                    <div class="inline" id="backdiv"><!--
                        --><div id="bspacer"></div><!--
                        --><div class="button" id="back">Back</div><!--
                    --></div><!--
                    --><div class="inline" id="sound"><!--
                        --><div id="movesound">&#x1f50a;</div><!--
                        --><div id="music">&#9835;</div><!--
                    --></div>
                `);
                $('#backdiv').css('width', ($('#soundback').width() * (3/4)) + 'px').css('height', $('#soundback').height() + 'px');
                $('#bspacer').css('height', ($('#soundback').height() * (1/8)) + 'px');
                $('#sound').css('width', ($('#soundback').width() * (1/4)) + 'px').css('height', $('#soundback').height() + 'px');
                $('#movesound, #music').css('width', $('#sound').width() + 'px').css('height', ($('#sound').height() / 2) + 'px').css('line-height', $('#movesound').height() + 'px').fitText(0.3);
                $('#back').css('width', '80%').css('height', '80%').css('line-height', $('#back').height() + 'px').fitText(0.6);
            }
        } else if (width > height) { // horizontal layout
            var page = `
                <div class="inline"><!--
                    --><div id="state"></div><!--
                    --><div id="players"></div><!--
                    --><div id="buttons"><!--
                        --><div class="inline"><!--
                            --><div id="soundback"></div><!--
                            --><div id="acknowledge"></div><!--
                        --></div><!--
                        --><div class="inline" id="promote"></div><!--
                    --></div><!--
                --></div><!--
                --><div class="inline" id="board"></div>
            `;
            $('#body').html(page);
            $('#board').css('width', height + 'px').css('height', height + 'px');
            $('#state').css('width', ((width - height) - (2 * StatePadding)) + 'px').css('height', ((height / 4) - (2 * StatePadding)) + 'px');
            $('#players').css('width', (width - height) + 'px').css('height', (height / 2) + 'px');
            $('#soundback').css('width', ((width - height) / 2) + 'px').css('height', (height / 8) + 'px');
            $('#acknowledge').css('width', ((width - height) / 2) + 'px').css('height', (height / 8) + 'px');
            $('#promote').css('width', ((width - height) / 2) + 'px').css('height', (height / 4) + 'px');
            $('#buttons').css('height', (height / 4) + 'px');
            if ((TotalTime.milliseconds() > 0) || (TurnTime.milliseconds() > 0)) {
                $('#players').html(`
                    <div id="black" class="player"><!--
                        --><div id="blackname"></div><!--
                        --><div id="blackclock" class="clock"></div><!--
                    --></div><!--
                    --><div id="white" class="player"><!--
                        --><div id="whitename"></div><!--
                        --><div id="whiteclock" class="clock"></div><!--
                    --></div>
                `);
            } else {
                $('#players').html(`
                    <div id="black" class="player"></div><!--
                    --><div id="white" class="player"></div>
                `);
            }
            $('.player').css('height', (($('#players').height() / 2) - (PlayerPadding * 2)) + 'px').css('width', ($('#players').width() - (PlayerPadding * 2)) + 'px');
            if (TotalTime.milliseconds() > 0) {
                $('#soundback').html(`
                    <div class="inline" id="movesound">&#x1f50a;</div><!--
                    --><div class="inline" id="music">&#9835;</div>
                `);
                $('#movesound, #music').css('width', ($('#soundback').width() / 2) + 'px').css('height', $('#soundback').height() + 'px').css('line-height', $('#movesound').height() + 'px').fitText(0.4);
            } else {
                $('#soundback').html(`
                    <div class="inline" id="backdiv"><!--
                        --><div class="button" id="back">Back</div><!--
                    --></div><!--
                    --><div class="inline" id="sound"><!--
                        --><div id="movesound">&#x1f50a;</div><!--
                        --><div id="music">&#9835;</div><!--
                    --></div>
                `);
                $('#backdiv').css('width', ($('#soundback').width() * (3/4)) + 'px').css('height', $('#soundback').height() + 'px');
                $('#sound').css('width', ($('#soundback').width() * (1/4)) + 'px').css('height', $('#soundback').height() + 'px');
                $('#movesound, #music').css('width', $('#sound').width() + 'px').css('height', ($('#sound').height() / 2) + 'px').css('line-height', $('#movesound').height() + 'px').fitText(0.3);
                $('#back').css('width', '80%').css('height', '80%').css('line-height', $('#back').height() + 'px').fitText(0.6);
            }
        } else { // vertical layout
            var page = `
                <div><!--
                    --><div id="top"><!--
                        --><div class="inline" id="state"></div><!--
                        --><div class="inline"><!--
                            --><div id="acknowledge"></div><!--
                            --><div><!--
                                --><div class="inline" id="promote"></div><!--
                                --><div class="inline" id="soundback"></div><!--
                            --></div><!--
                        --></div><!--
                    --></div><!--
                    --><div id="players"></div><!--
                --></div><!--
                --><div id="board"></div>
            `;
            $('#body').html(page);
            $('#board').css('width', width + 'px').css('height', width + 'px');
            $('#state').css('width', ((width / 2) - (2 * StatePadding)) + 'px').css('height', (((height - width) / 2) - (2 * StatePadding)) + 'px');
            $('#top').css('height', ((height - width) / 2) + 'px');
            $('#acknowledge').css('width', (width / 2) + 'px').css('height', ((height - width) / 4) + 'px');
            $('#promote').css('width', (width / 4) + 'px').css('height', ((height - width) / 4) + 'px');
            $('#soundback').css('width', (width / 4) + 'px').css('height', ((height - width) / 4) + 'px');
            $('#players').css('width', width + 'px').css('height', ((height - width) / 2) + 'px');
            if ((TotalTime.milliseconds() > 0) || (TurnTime.milliseconds() > 0)) {
                $('#players').html(`
                    <div id="black" class="player inline"><!--
                        --><div id="blackname"></div><!--
                        --><div id="blackclock" class="clock"></div><!--
                    --></div><!--
                    --><div id="white" class="player inline"><!--
                        --><div id="whitename"></div><!--
                        --><div id="whiteclock" class="clock"></div><!--
                    --></div>
                `);
            } else {
                $('#players').html(`
                    <div id="black" class="player inline"></div><!--
                    --><div id="white" class="player inline"></div>
                `);
            }
            $('.player').css('height', ($('#players').height() - (PlayerPadding * 2)) + 'px').css('width', (($('#players').width() / 2) - (PlayerPadding * 2)) + 'px');
            if (TotalTime.milliseconds() > 0) {
                $('#soundback').html(`
                    <div class="inline" id="movesound">&#x1f50a;</div><!--
                    --><div class="inline" id="music">&#9835;</div>
                `);
                $('#movesound, #music').css('width', ($('#soundback').width() / 2) + 'px').css('height', $('#soundback').height() + 'px').css('line-height', $('#movesound').height() + 'px').fitText(0.3);
            } else {
                $('#soundback').html(`
                    <div class="inline" id="backdiv"><!--
                        --><div class="button" id="back">Back</div><!--
                    --></div><!--
                    --><div class="inline" id="sound"><!--
                        --><div id="movesound">&#x1f50a;</div><!--
                        --><div id="music">&#9835;</div><!--
                    --></div>
                `);
                $('#backdiv').css('width', ($('#soundback').width() * (3/4)) + 'px').css('height', $('#soundback').height() + 'px');
                $('#sound').css('width', ($('#soundback').width() * (1/4)) + 'px').css('height', $('#soundback').height() + 'px');
                $('#movesound, #music').css('width', $('#sound').width() + 'px').css('height', ($('#sound').height() / 2) + 'px').css('line-height', $('#movesound').height() + 'px').fitText(0.2);
                $('#back').css('width', '80%').css('height', '80%').css('line-height', $('#back').height() + 'px').fitText(0.4);
            }
        }
        if (Turn == o.WHITE) {
            $('#white').addClass('indicating');
            $('#black').removeClass('indicating');
        } else {
            $('#white').removeClass('indicating');
            $('#black').addClass('indicating');
        }
        if ((TotalTime.milliseconds() > 0) || (TurnTime.milliseconds() > 0)) {
            $('#blackname').css('height', '50%').css('width', '100%').css('line-height', $('#blackname').height() + 'px');
            $('#whitename').css('height', '50%').css('width', '100%').css('line-height', $('#whitename').height() + 'px');
            $('#blackclock').css('height', '50%').css('width', '100%').css('line-height', $('#blackclock').height() + 'px');
            $('#whiteclock').css('height', '50%').css('width', '100%').css('line-height', $('#whiteclock').height() + 'px');
            if (White == Player) {
                $('#whitename').html('> '+{{.White}});
                $('#blackname').html({{.Black}});
            } else {
                $('#blackname').html('> '+{{.Black}});
                $('#whitename').html({{.White}});
            }
            $('#whitename, #blackname').fitText();
        } else {
            $('#black').css('line-height', $('#black').height() + 'px');
            $('#white').css('line-height', $('#white').height() + 'px');
            if (White == Player) {
                $('#white').html('> '+{{.White}});
                $('#black').html({{.Black}});
            } else {
                $('#black').html('> '+{{.Black}});
                $('#white').html({{.White}});
            }
            $('#white, #black').fitText(1.5);
        }
        if (TurnTime.milliseconds() > 0) {
            if (Turn == o.WHITE) {
                $('#blackclock').html(millisecondsToClock(TurnTime.valueOf()-1000)).addClass('clock').fitText();
                updateClock(o.WHITE);
                $('#whiteclock').addClass('clock').fitText();
                if (Acknowledging == false) {
                    WhiteTimer = setInterval(function() {
                        updateClock(o.WHITE);
                    }, 1000);
                }
            } else {
                $('#whiteclock').html(millisecondsToClock(TurnTime.valueOf()-1000)).addClass('clock').fitText();
                updateClock(o.BLACK);
                $('#blackclock').addClass('clock').fitText();
                if (Acknowledging == false) {
                    BlackTimer = setInterval(function() {
                        updateClock(o.BLACK);
                    }, 1000);            
                }
            }
        } else if (TotalTime.milliseconds() > 0) {
            var btime = TotalTime.milliseconds()-BlackElapsed.milliseconds()-1000;
            if (btime < 0) {
                btime = 0;
            }
            var wtime = TotalTime.milliseconds()-WhiteElapsed.milliseconds()-1000;
            if (wtime < 0) {
                wtime = 0;
            }
            if (typeof whiteTime === 'undefined') {
                $('#blackclock').html(millisecondsToClock(btime)).addClass('clock').fitText();
                $('#whiteclock').html(millisecondsToClock(wtime)).addClass('clock').fitText();
            } else {
                $('#whiteclock').html(whiteTime).addClass('clock').fitText();
                $('#blackclock').html(blackTime).addClass('clock').fitText();
            }
            if (Acknowledging == false) {
                if (Turn == o.WHITE) {
                    WhiteTimer = setInterval(function() {
                        updateClock(o.WHITE);
                    }, 1000);
                } else {
                    BlackTimer = setInterval(function() {
                        updateClock(o.BLACK);
                    }, 1000);
                }
            }
        }
        $('#back').click(function() {
            window.location.pathname = '/';
        });
        $('#movesound').click(function() {
            if (Muted == false) {
                $('#movesound').html('&#x1f507;');
                Muted = true;
            } else {
                $('#movesound').html('&#x1f50a;');
                Muted = false;
            }
        });
        var board = '';
        board += '<table>';
        for (var yrr = 7; yrr >= 0; yrr--) {
            board += '<tr>';
            for (var xcf = 0; xcf < 8; xcf++) {
                board += '<td id="point'+(xcf+(yrr*8))+'" class="point"></td>';
            }
            board += '</tr>';
        }
        board += '</table>';
        $('#board').html(board);
        for (var i = 0; i < 64; i++) {
            var y = Math.floor(i / 8);
            var x = i % 8;
            if ((y%2) == 0) {
                if ((x%2) == 0) {
                    $('#point'+i).addClass('even');
                } else {
                    $('#point'+i).addClass('odd');
                }
            } else {
                if ((x%2) == 0) {
                    $('#point'+i).addClass('odd');
                } else {
                    $('#point'+i).addClass('even');
                }
            }
        }
        var dim = Math.floor(($('#board').height() - (2 * BoardPadding)) / 8);
        $('tr').css('height', dim + 'px');
        $('.point').css('width', dim + 'px');
        assignPieceImages(dim);
        for (var i = 0; i < 64; i++) {
            $('#point'+i).click({Index: i}, function(event) {
                var index = event.data.Index;
                var className = '';
                if ((Selected != index) && ($('#point'+index).hasClass('selected'))) {
                    if (Turn == PlayerOrientation) {
                        requestMove(Selected, index);
                    }
                    return;
                }
                if (Board[index].Kind == 0) {
                    return;
                }
                if (Moves[indexToAddrString(index)] == null) {
                    return;
                }
                if (Selected != null) {
                    if (Board[Selected].Orientation == PlayerOrientation) {
                        className = 'selected';
                    } else {
                        className = 'selectedopp';
                    }
                    $('#point'+Selected).removeClass(className);
                    for (var point in Moves[indexToAddrString(Selected)]) {
                        $('#point'+addrStringToIndex(point)).removeClass(className);
                    }
                    if (Selected == index) {
                        Selected = null;
                        return;
                    }
                }
                if (Board[index].Orientation == PlayerOrientation) {
                    className = 'selected';
                } else {
                    className = 'selectedopp';
                }
                $('#point'+index).addClass(className);
                for (var point in Moves[indexToAddrString(index)]) {
                    $('#point'+addrStringToIndex(point)).addClass(className);
                }
                Selected = index;
            }).mouseenter({Index: i}, function(event) {
                var index = event.data.Index;
                var className;
                if (Board[index].Kind == 0) {
                    return;
                }
                if (Moves[indexToAddrString(index)] == null) {
                    return;
                }
                if (Board[index].Orientation == PlayerOrientation) {
                    className = 'hovered';
                } else {
                    className = 'hoveredopp';
                }
                $('#point'+index).addClass(className);
                for (var point in Moves[indexToAddrString(index)]) {
                    $('#point'+addrStringToIndex(point)).addClass(className);
                }
            }).mouseleave({Index: i}, function(event) {
                var index = event.data.Index;
                var className;
                if (Board[index].Kind == 0) {
                    return;
                }
                if (Moves[indexToAddrString(index)] == null) {
                    return;
                }
                if (Board[index].Orientation == PlayerOrientation) {
                    className = 'hovered';
                } else {
                    className = 'hoveredopp';
                }
                $('#point'+index).removeClass(className);
                for (var point in Moves[indexToAddrString(index)]) {
                    $('#point'+addrStringToIndex(point)).removeClass(className);
                }
            });
        }
        setState(GameState);
        if (Acknowledging) {
            setAcknowledge();
        }
        if (GainedPiece != null) {
            setGainedPiece();
        } else if (Promoting) {
            setPromoting();
        }
    }
    function assignPieceImages(dimension) {
        if (Board != null) {
            for (var i = 0; i < Board.length; i++) {
                if (Board[i].Kind == 0) {
                    continue;
                } else {
                    setPieceImage(i, Board[i].Kind, Board[i].Orientation);
                }
            }
            $('.pieceimg').css('width', dimension + 'px').css('height', dimension + 'px');
        }
    }
    $(window).resize(function() {
        layout($(window).width(), $(window).height());
    });
    $(document).ready(function() {
        $.get('/games/'+game_id).done(function(data) {
            Board = data.Points;
            White = data.White;
            Black = data.Black;
            if ((TotalTime.milliseconds() > 0) || (TurnTime.milliseconds() > 0)) {
                if (White == Player) {
                    Opponent = Black;
                    PlayerOrientation = o.WHITE;
                } else {
                    Opponent = White;
                    PlayerOrientation = o.BLACK;
                }
            } else {
                if (White == Player) {
                    Opponent = Black;
                    PlayerOrientation = o.WHITE;
                } else {
                    Opponent = White;
                    PlayerOrientation = o.BLACK;
                }
            }
            if (data.Active == White) {
                Turn = o.WHITE;
            } else {
                Turn = o.BLACK;
            }
            layout($(window).width(), $(window).height());
            getMoves();
        });
    });
    </script>
</head>
<body>
    <div id="body"></div>
</body>
</html>
