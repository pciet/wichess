<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>wichess game</title>
    <style>
    div {
        text-align: center;
        margin: 0 auto;
        width: 100%;
    }
    table {
        table-layout: fixed;
        border-collapse: collapse;
        width: 512px;
        margin: 0 auto;
    }
    tr {
        height: 64px;
    }
    .point {
        width: 64px;
        border: 0.5px solid black;
    }
    .spacer {
        height: 20px;
    }
    .pieceimg {
        width: 100%;
        height: auto;
    }
    .move {
        border: 2px solid black;
    }
    </style>
    <script type="text/javascript" src="/js/jquery-2.2.0.min.js"></script>
    <script type="text/javascript">
    var k = {
        KING: 1,
        QUEEN: 2,
        ROOK: 3,
        BISHOP: 4,
        KNIGHT: 5,
        PAWN: 6,
        SWAP: 7,
        LOCK: 8,
        RECON: 9,
        DETONATE: 10,
        GHOST: 11,
        STEAL: 12,
        GUARD: 13,
        RALLY: 14,
        FORTIFY: 15
    };
    var o = {
        WHITE: 0,
        BLACK: 1
    };
    function imageNameForKind(kind, point, orientation) {
        var name;
        if (orientation == o.WHITE) {
            name = 'w';
        } else {
            name = 'b';
        }
        switch (kind) {
            case k.KING:
                name += 'king';
                break;
            case k.QUEEN:
                name += 'queen';
                break;
            case k.ROOK:
                name += 'rook';
                break;
            case k.BISHOP:
                name += 'bishop';
                break;
            case k.KNIGHT:
                name += 'knight';
                break;
            case k.PAWN:
                name += 'pawn';
                break;
            case k.SWAP:
                name += 'swap';
                break;
            case k.LOCK:
                name += 'lock';
                break;
            case k.RECON:
                name += 'recon';
                break;
            case k.DETONATE:
                name += 'detonate';
                break;
            case k.GHOST:
                name += 'ghost';
                break;
            case k.STEAL:
                name += 'steal';
                break;
            case k.GUARD:
                name += 'guard';
                break;
            case RALLY:
                name += 'rally';
                break;
            case FORTIFY:
                name += 'fortify';
                break;
        }
        return name + '_' + point + '.png';
    }
    $(document).ready(function() {
        var board = '';
        board += '<table id="grid">';
        for (var yrr = 7; yrr >= 0; yrr--) {
            board += '<tr>';
            for (var xcf = 0; xcf < 8; xcf++) {
                board += '<td id="point'+(xcf+(yrr*8))+'" class="point"></td>';
            }
            board += '</tr>';
        }
        board += '</table>';
        $('#board').html(board);

        var game_id = {{.GameID}};
        var player = {{.Name}};
        var opponent = '';
        var white = '';
        var black = '';
        $.get('/games/'+game_id).done(function(data) {
            white = data.White;
            black = data.Black;
            if (white == player) {
                opponent = black;
            } else {
                opponent = white;
            }
            for (var i = 0; i < data.Points.length; i++) {
                if (data.Points[i].Kind == 0) {
                    continue;
                } else {
                    $('#point'+i).html('<img class="pieceimg" src="img/'+imageNameForKind(data.Points[i].Kind, i, data.Points[i].Orientation)+'">');
                }
            }
        });
        var Moves = null;
        $.get('/moves/'+game_id).done(function(data) {
            Moves = data;
            for (var point in data) {
                if (data.hasOwnProperty(point) == false) {
                    continue;
                }
                $('#point'+addrStringToIndex(point)).mouseover({addr: point}, function(event) {
                    for (var hp in Moves[event.data.addr]) {
                        $('#point'+addrStringToIndex(hp)).toggleClass('move');
                    }
                }).mouseout({addr: point}, function(event) {
                    for (var hp in Moves[event.data.addr]) {
                        $('#point'+addrStringToIndex(hp)).toggleClass('move');
                    }
                });
            }
        });
        function addrStringToIndex(str) {
            var address = str.split('-');
            return parseInt(address[0], 10) + (8 * parseInt(address[1], 10))
        }
    });
    </script>
</head>

<body>
    <div class="spacer"></div>
    <div>{{.White}}</div>
    <div class="spacer"></div>
    <div id="board"></div>
    <div class="spacer"></div>
    <div>{{.Black}}</div>
</body>
</html>
